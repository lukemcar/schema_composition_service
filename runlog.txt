>>> Installing project (editable)...
>>> Compiling all python source files...
#1 [schema_composition_service-schema-composition-service internal] load build definition from Dockerfile
#1 transferring dockerfile: 1.36kB done
#1 DONE 0.0s

#2 [schema_composition_service-schema-composition-worker internal] load build definition from Dockerfile
#2 transferring dockerfile: 1.45kB done
#2 DONE 0.0s

#3 [schema_composition_service-schema-composition-worker internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [schema_composition_service-schema-composition-service internal] load .dockerignore
#4 transferring context: 2B done
#4 DONE 0.0s

#5 [schema_composition_service-schema-composition-service] resolve image config for docker.io/docker/dockerfile:1
#5 DONE 1.0s

#6 [schema_composition_service-schema-composition-service] docker-image://docker.io/docker/dockerfile:1@sha256:b6afd42430b15f2d2a4c5a02b919e98a525b785b1aaff16747d2f623364e39b6
#6 CACHED

#7 [schema_composition_service-schema-composition-worker internal] load build definition from Dockerfile
#7 DONE 0.0s

#8 [schema_composition_service-schema-composition-service internal] load build definition from Dockerfile
#8 DONE 0.0s

#9 [schema_composition_service-schema-composition-service internal] load metadata for docker.io/library/python:3.11-slim
#9 DONE 0.7s

#10 [schema_composition_service-schema-composition-worker internal] load .dockerignore
#10 DONE 0.0s

#11 [schema_composition_service-schema-composition-service internal] load .dockerignore
#11 DONE 0.0s

#12 [schema_composition_service-schema-composition-worker base 1/3] FROM docker.io/library/python:3.11-slim@sha256:c24e9effa2821a6885165d930d939fec2af0dcf819276138f11dd45e200bd032
#12 DONE 0.0s

#13 [schema_composition_service-schema-composition-worker internal] load build context
#13 transferring context: 1.47MB 0.6s done
#13 DONE 0.7s

#14 [schema_composition_service-schema-composition-service internal] load build context
#14 transferring context: 1.47MB 0.6s done
#14 DONE 0.8s

#15 [schema_composition_service-schema-composition-worker base 3/3] WORKDIR /app
#15 CACHED

#16 [schema_composition_service-schema-composition-worker deps 1/4] WORKDIR /app
#16 CACHED

#17 [schema_composition_service-schema-composition-worker deps 4/4] RUN pip install --no-cache-dir .
#17 CACHED

#18 [schema_composition_service-schema-composition-worker deps 2/4] COPY pyproject.toml /app/
#18 CACHED

#19 [schema_composition_service-schema-composition-worker deps 3/4] COPY app /app/app
#19 CACHED

#20 [schema_composition_service-schema-composition-worker worker 2/4] COPY --from=deps /usr/local/lib/python3.11 /usr/local/lib/python3.11
#20 CACHED

#21 [schema_composition_service-schema-composition-worker base 2/3] RUN apt-get update     && apt-get install -y --no-install-recommends         build-essential         libpq-dev     && rm -rf /var/lib/apt/lists/*
#21 CACHED

#22 [schema_composition_service-schema-composition-worker worker 3/4] COPY --from=deps /usr/local/bin /usr/local/bin
#22 CACHED

#23 [schema_composition_service-schema-composition-service deps 2/4] COPY pyproject.toml /app/
#23 CACHED

#24 [schema_composition_service-schema-composition-service base 2/3] RUN apt-get update     && apt-get install -y --no-install-recommends         build-essential         libpq-dev         default-jdk-headless     && rm -rf /var/lib/apt/lists/*
#24 CACHED

#25 [schema_composition_service-schema-composition-service app 2/4] COPY --from=deps /usr/local/lib/python3.11 /usr/local/lib/python3.11
#25 CACHED

#26 [schema_composition_service-schema-composition-service base 3/3] WORKDIR /app
#26 CACHED

#27 [schema_composition_service-schema-composition-service deps 1/4] WORKDIR /app
#27 CACHED

#28 [schema_composition_service-schema-composition-service deps 3/4] COPY app /app/app
#28 CACHED

#29 [schema_composition_service-schema-composition-service deps 4/4] RUN pip install --no-cache-dir .
#29 CACHED

#30 [schema_composition_service-schema-composition-service app 3/4] COPY --from=deps /usr/local/bin /usr/local/bin
#30 CACHED

#31 [schema_composition_service-schema-composition-service app 4/4] COPY . /app
#31 DONE 7.3s

#32 [schema_composition_service-schema-composition-worker worker 4/4] COPY . /app
#32 DONE 7.3s

#33 [schema_composition_service-schema-composition-service] exporting to image
#33 exporting layers
#33 exporting layers 2.2s done
#33 exporting layers 2.3s done
#33 writing image sha256:7f4f08bae28ab22cd4f282e8b33a410aa21327060a7c829ac232be4417ee25a7 done
#33 naming to docker.io/library/schema_composition_service-schema-composition-service done
#33 writing image sha256:c16df5557f54748d19ea80262332938490489462d95a9705b032dd548f1632a0 done
#33 naming to docker.io/library/schema_composition_service-schema-composition-worker done
#33 DONE 2.3s
Container schema_composition_rabbitmq  Running
Container schema_composition_jaeger  Running
Container schema_composition_db  Running
Container schema_composition_otel_collector  Running
Container schema_composition_worker  Recreate
Container schema_composition_service_app  Recreate
Container schema_composition_service_app  Recreated
Container schema_composition_worker  Recreated
Attaching to schema_composition_db, schema_composition_jaeger, schema_composition_otel_collector, schema_composition_rabbitmq, schema_composition_service_app, schema_composition_worker
schema_composition_worker          | /usr/local/lib/python3.11/site-packages/celery/platforms.py:841: SecurityWarning: You're running the worker with superuser privileges: this is
schema_composition_worker          | absolutely not recommended!
schema_composition_worker          | 
schema_composition_worker          | Please specify a different user using the --uid option.
schema_composition_worker          | 
schema_composition_worker          | User information: uid=0 euid=0 gid=0 egid=0
schema_composition_worker          | 
schema_composition_worker          |   warnings.warn(SecurityWarning(ROOT_DISCOURAGED.format(
schema_composition_worker          |  
schema_composition_worker          |  -------------- celery@66b9bb28f4b2 v5.6.2 (recovery)
schema_composition_worker          | --- ***** ----- 
schema_composition_worker          | -- ******* ---- Linux-5.15.49-linuxkit-aarch64-with-glibc2.41 2026-01-15 03:53:22
schema_composition_worker          | - *** --- * --- 
schema_composition_worker          | - ** ---------- [config]
schema_composition_worker          | - ** ---------- .> app:         schema-composition-service:0xffff984bd610
schema_composition_worker          | - ** ---------- .> transport:   amqp://schema_composition:**@rabbitmq:5672/schema_composition
schema_composition_worker          | - ** ---------- .> results:     rpc://
schema_composition_worker          | - *** --- * --- .> concurrency: 5 (prefork)
schema_composition_worker          | -- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
schema_composition_worker          | --- ***** ----- 
schema_composition_worker          |  -------------- [queues]
schema_composition_worker          |                 .> SchemaComposition.component exchange=SchemaComposition(topic) key=SchemaComposition.component.#
schema_composition_worker          |                 .> SchemaComposition.component-panel exchange=SchemaComposition(topic) key=SchemaComposition.component-panel.#
schema_composition_worker          |                 .> SchemaComposition.component-panel-field exchange=SchemaComposition(topic) key=SchemaComposition.component-panel-field.#
schema_composition_worker          |                 .> SchemaComposition.component-panel-field.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.component-panel-field.dlq
schema_composition_worker          |                 .> SchemaComposition.component-panel.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.component-panel.dlq
schema_composition_worker          |                 .> SchemaComposition.component.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.component.dlq
schema_composition_worker          |                 .> SchemaComposition.default exchange=SchemaComposition(topic) key=SchemaComposition.default
schema_composition_worker          |                 .> SchemaComposition.field-def exchange=SchemaComposition(topic) key=SchemaComposition.field-def.#
schema_composition_worker          |                 .> SchemaComposition.field-def-option exchange=SchemaComposition(topic) key=SchemaComposition.field-def-option.#
schema_composition_worker          |                 .> SchemaComposition.field-def-option.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.field-def-option.dlq
schema_composition_worker          |                 .> SchemaComposition.field-def.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.field-def.dlq
schema_composition_worker          |                 .> SchemaComposition.form exchange=SchemaComposition(topic) key=SchemaComposition.form.#
schema_composition_worker          |                 .> SchemaComposition.form-catalog-category exchange=SchemaComposition(topic) key=SchemaComposition.form-catalog-category.#
schema_composition_worker          |                 .> SchemaComposition.form-catalog-category.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-catalog-category.dlq
schema_composition_worker          |                 .> SchemaComposition.form-panel exchange=SchemaComposition(topic) key=SchemaComposition.form-panel.#
schema_composition_worker          |                 .> SchemaComposition.form-panel-component exchange=SchemaComposition(topic) key=SchemaComposition.form-panel-component.#
schema_composition_worker          |                 .> SchemaComposition.form-panel-component.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-panel-component.dlq
schema_composition_worker          |                 .> SchemaComposition.form-panel-field exchange=SchemaComposition(topic) key=SchemaComposition.form-panel-field.#
schema_composition_worker          |                 .> SchemaComposition.form-panel-field.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-panel-field.dlq
schema_composition_worker          |                 .> SchemaComposition.form-panel.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-panel.dlq
schema_composition_worker          |                 .> SchemaComposition.form-submission exchange=SchemaComposition(topic) key=SchemaComposition.form-submission.#
schema_composition_worker          |                 .> SchemaComposition.form-submission-value exchange=SchemaComposition(topic) key=SchemaComposition.form-submission-value.#
schema_composition_worker          |                 .> SchemaComposition.form-submission-value.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-submission-value.dlq
schema_composition_worker          |                 .> SchemaComposition.form-submission.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form-submission.dlq
schema_composition_worker          |                 .> SchemaComposition.form.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.form.dlq
schema_composition_worker          |                 .> SchemaComposition.schema-composition exchange=SchemaComposition(topic) key=SchemaComposition.schema-composition.#
schema_composition_worker          |                 .> SchemaComposition.schema-composition.dlq exchange=SchemaComposition.dlx(topic) key=SchemaComposition.schema-composition.dlq
schema_composition_worker          | 
schema_composition_worker          | [tasks]
schema_composition_worker          |   . SchemaComposition.component-panel.created
schema_composition_worker          |   . SchemaComposition.component-panel.deleted
schema_composition_worker          |   . SchemaComposition.component-panel.updated
schema_composition_worker          |   . SchemaComposition.component.created
schema_composition_worker          |   . SchemaComposition.component.deleted
schema_composition_worker          |   . SchemaComposition.component.updated
schema_composition_worker          |   . SchemaComposition.field-def-option.created
schema_composition_worker          |   . SchemaComposition.field-def-option.deleted
schema_composition_worker          |   . SchemaComposition.field-def-option.updated
schema_composition_worker          |   . SchemaComposition.field-def.created
schema_composition_worker          |   . SchemaComposition.field-def.deleted
schema_composition_worker          |   . SchemaComposition.field-def.updated
schema_composition_worker          |   . SchemaComposition.form-catalog-category.created
schema_composition_worker          |   . SchemaComposition.form-catalog-category.deleted
schema_composition_worker          |   . SchemaComposition.form-catalog-category.updated
schema_composition_worker          |   . SchemaComposition.form-panel-component.created
schema_composition_worker          |   . SchemaComposition.form-panel-component.deleted
schema_composition_worker          |   . SchemaComposition.form-panel-component.updated
schema_composition_worker          |   . SchemaComposition.form-panel-field.created
schema_composition_worker          |   . SchemaComposition.form-panel-field.deleted
schema_composition_worker          |   . SchemaComposition.form-panel-field.updated
schema_composition_worker          |   . SchemaComposition.form-panel.created
schema_composition_worker          |   . SchemaComposition.form-panel.deleted
schema_composition_worker          |   . SchemaComposition.form-panel.updated
schema_composition_worker          |   . SchemaComposition.form-submission-value.created
schema_composition_worker          |   . SchemaComposition.form-submission-value.deleted
schema_composition_worker          |   . SchemaComposition.form-submission-value.updated
schema_composition_worker          |   . SchemaComposition.form-submission.created
schema_composition_worker          |   . SchemaComposition.form-submission.deleted
schema_composition_worker          |   . SchemaComposition.form-submission.updated
schema_composition_worker          |   . SchemaComposition.form.created
schema_composition_worker          |   . SchemaComposition.form.deleted
schema_composition_worker          |   . SchemaComposition.form.updated
schema_composition_worker          | 
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.829803Z", "level": "WARNING", "name": "opentelemetry.trace", "message": "Overriding of current TracerProvider is not allowed"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.830009Z", "level": "INFO", "name": "app.core.telemetry", "message": "OpenTelemetry tracing configured for schema-composition-service.api"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.830421Z", "level": "INFO", "name": "app.core.telemetry", "message": "FastAPI application instrumented for tracing"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.830493Z", "level": "WARNING", "name": "opentelemetry.instrumentation.instrumentor", "message": "Attempting to instrument while already instrumented"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.830538Z", "level": "INFO", "name": "app.core.telemetry", "message": "httpx globally instrumented for tracing"}
schema_composition_service_app     | INFO:     Started server process [1]
schema_composition_service_app     | INFO:     Waiting for application startup.
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.946423Z", "level": "INFO", "name": "SchemaComposition", "message": "startup_event: SchemaComposition Service is starting"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.946576Z", "level": "INFO", "name": "root", "message": "Starting Liquibase schema validation and update: migrations/liquibase/docker-liquibase.properties"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.947621Z", "level": "WARNING", "name": "pyliquibase", "message": "Downloading Liquibase version: 4.21.1 ..."}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:22.948845Z", "level": "INFO", "name": "pyliquibase", "message": "Downloading https://github.com/liquibase/liquibase/releases/download/v4.21.1/liquibase-4.21.1.zip to /usr/local/lib/python3.11/site-packages/pyliquibase/liquibase-4.21.1"}
schema_composition_rabbitmq        | 2026-01-15 03:53:23.263824+00:00 [info] <0.2133.0> accepting AMQP connection 172.30.0.6:39614 -> 172.30.0.2:5672[0m
schema_composition_worker          | [2026-01-15 03:53:23,275: INFO/MainProcess] Connected to amqp://schema_composition:**@rabbitmq:5672/schema_composition
schema_composition_rabbitmq        | 2026-01-15 03:53:23.275035+00:00 [info] <0.2133.0> connection 172.30.0.6:39614 -> 172.30.0.2:5672: user 'schema_composition' authenticated and granted access to vhost 'schema_composition'[0m
schema_composition_rabbitmq        | 2026-01-15 03:53:23.280441+00:00 [info] <0.2142.0> accepting AMQP connection 172.30.0.6:39626 -> 172.30.0.2:5672[0m
schema_composition_rabbitmq        | 2026-01-15 03:53:23.287893+00:00 [info] <0.2142.0> connection 172.30.0.6:39626 -> 172.30.0.2:5672: user 'schema_composition' authenticated and granted access to vhost 'schema_composition'[0m
schema_composition_worker          | [2026-01-15 03:53:23,288: INFO/MainProcess] mingle: searching for neighbors
schema_composition_rabbitmq        | 2026-01-15 03:53:23.313799+00:00 [info] <0.2157.0> accepting AMQP connection 172.30.0.6:39640 -> 172.30.0.2:5672[0m
schema_composition_rabbitmq        | 2026-01-15 03:53:23.315754+00:00 [info] <0.2157.0> connection 172.30.0.6:39640 -> 172.30.0.2:5672: user 'schema_composition' authenticated and granted access to vhost 'schema_composition'[0m
schema_composition_worker          | [2026-01-15 03:53:24,323: INFO/MainProcess] mingle: all alone
schema_composition_worker          | [2026-01-15 03:53:24,399: INFO/MainProcess] celery@66b9bb28f4b2 ready.
schema_composition_service_app     | liquibase-4.21.1.zip: 0.00B [00:00, ?B/s]liquibase-4.21.1.zip:   0%|          | 8.00k/66.1M [00:00<58:31, 19.7kB/s]liquibase-4.21.1.zip:   1%|          | 592k/66.1M [00:00<00:44, 1.55MB/s] liquibase-4.21.1.zip:   7%|â–‹         | 4.95M/66.1M [00:00<00:05, 12.5MB/s]liquibase-4.21.1.zip:  20%|â–ˆâ–‰        | 13.2M/66.1M [00:00<00:01, 31.6MB/s]liquibase-4.21.1.zip:  29%|â–ˆâ–ˆâ–‰       | 19.1M/66.1M [00:00<00:01, 40.0MB/s]liquibase-4.21.1.zip:  37%|â–ˆâ–ˆâ–ˆâ–‹      | 24.5M/66.1M [00:00<00:00, 44.7MB/s]liquibase-4.21.1.zip:  47%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 30.9M/66.1M [00:01<00:00, 50.7MB/s]liquibase-4.21.1.zip:  56%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 37.3M/66.1M [00:01<00:00, 55.3MB/s]liquibase-4.21.1.zip:  66%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ   | 43.7M/66.1M [00:01<00:00, 58.7MB/s]liquibase-4.21.1.zip:  76%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ  | 50.0M/66.1M [00:01<00:00, 60.7MB/s]liquibase-4.21.1.zip:  85%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ | 56.5M/66.1M [00:01<00:00, 62.8MB/s]liquibase-4.21.1.zip:  95%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–| 62.8M/66.1M [00:01<00:00, 64.0MB/s]liquibase-4.21.1.zip: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 66.1M/66.1M [00:01<00:00, 43.0MB/s]
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:24.576037Z", "level": "INFO", "name": "pyliquibase", "message": "Extracting /tmp/tmplej58d6n_liquibase.zip to /usr/local/lib/python3.11/site-packages/pyliquibase/liquibase-4.21.1"}
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:25.945818Z", "level": "WARNING", "name": "pyliquibase", "message": "Current working dir is /app"}
schema_composition_service_app     | ####################################################
schema_composition_service_app     | ##   _     _             _ _                      ##
schema_composition_service_app     | ##  | |   (_)           (_) |                     ##
schema_composition_service_app     | ##  | |    _  __ _ _   _ _| |__   __ _ ___  ___   ##
schema_composition_service_app     | ##  | |   | |/ _` | | | | | '_ \ / _` / __|/ _ \  ##
schema_composition_service_app     | ##  | |___| | (_| | |_| | | |_) | (_| \__ \  __/  ##
schema_composition_service_app     | ##  \_____/_|\__, |\__,_|_|_.__/ \__,_|___/\___|  ##
schema_composition_service_app     | ##              | |                               ##
schema_composition_service_app     | ##              |_|                               ##
schema_composition_service_app     | ##                                                ## 
schema_composition_service_app     | ##  Get documentation at docs.liquibase.com       ##
schema_composition_service_app     | ##  Get certified courses at learn.liquibase.com  ## 
schema_composition_service_app     | ##  Free schema change activity reports at        ##
schema_composition_service_app     | ##      https://hub.liquibase.com                 ##
schema_composition_service_app     | ##                                                ##
schema_composition_service_app     | ####################################################
schema_composition_service_app     | Starting Liquibase at 03:53:26 (version 4.21.1 #9070 built at 2023-04-13 20:56+0000)
schema_composition_service_app     | Liquibase Version: 4.21.1
schema_composition_service_app     | Liquibase Open Source 4.21.1 by Liquibase
schema_composition_service_app     | WARNING: 
schema_composition_service_app     | 
schema_composition_service_app     | Liquibase detected the following invalid LIQUIBASE_* environment variables:
schema_composition_service_app     | 
schema_composition_service_app     | - LIQUIBASE_ENABLED
schema_composition_service_app     | - LIQUIBASE_PROPERTY_FILE
schema_composition_service_app     | 
schema_composition_service_app     | Find the list of valid environment variables at https://docs.liquibase.com/environment-variables
schema_composition_service_app     | 
schema_composition_service_app     | INFO: An older version of the XSD is specified in one or more changelog's <databaseChangeLog> header. This can lead to unexpected outcomes. If a specific XSD is not required, please replace all XSD version references with "-latest". Learn more at https://docs.liquibase.com
schema_composition_service_app     | No validation errors found.
schema_composition_service_app     | Liquibase command 'validate' was executed successfully.
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:26.465829Z", "level": "WARNING", "name": "pyliquibase", "message": "Current working dir is /app"}
schema_composition_service_app     | ####################################################
schema_composition_service_app     | ##   _     _             _ _                      ##
schema_composition_service_app     | ##  | |   (_)           (_) |                     ##
schema_composition_service_app     | ##  | |    _  __ _ _   _ _| |__   __ _ ___  ___   ##
schema_composition_service_app     | ##  | |   | |/ _` | | | | | '_ \ / _` / __|/ _ \  ##
schema_composition_service_app     | ##  | |___| | (_| | |_| | | |_) | (_| \__ \  __/  ##
schema_composition_service_app     | ##  \_____/_|\__, |\__,_|_|_.__/ \__,_|___/\___|  ##
schema_composition_service_app     | ##              | |                               ##
schema_composition_service_app     | ##              |_|                               ##
schema_composition_service_app     | ##                                                ## 
schema_composition_service_app     | ##  Get documentation at docs.liquibase.com       ##
schema_composition_service_app     | ##  Get certified courses at learn.liquibase.com  ## 
schema_composition_service_app     | ##  Free schema change activity reports at        ##
schema_composition_service_app     | ##      https://hub.liquibase.com                 ##
schema_composition_service_app     | ##                                                ##
schema_composition_service_app     | ####################################################
schema_composition_service_app     | Starting Liquibase at 03:53:26 (version 4.21.1 #9070 built at 2023-04-13 20:56+0000)
schema_composition_service_app     | Liquibase Version: 4.21.1
schema_composition_service_app     | Liquibase Open Source 4.21.1 by Liquibase
schema_composition_service_app     | 1 changesets have not been applied to supabase_admin@jdbc:postgresql://db:5432/schema_composition_db
schema_composition_service_app     | Liquibase command 'status' was executed successfully.
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:26.510334Z", "level": "WARNING", "name": "pyliquibase", "message": "Current working dir is /app"}
schema_composition_service_app     | ####################################################
schema_composition_service_app     | ##   _     _             _ _                      ##
schema_composition_service_app     | ##  | |   (_)           (_) |                     ##
schema_composition_service_app     | ##  | |    _  __ _ _   _ _| |__   __ _ ___  ___   ##
schema_composition_service_app     | ##  | |   | |/ _` | | | | | '_ \ / _` / __|/ _ \  ##
schema_composition_service_app     | ##  | |___| | (_| | |_| | | |_) | (_| \__ \  __/  ##
schema_composition_service_app     | ##  \_____/_|\__, |\__,_|_|_.__/ \__,_|___/\___|  ##
schema_composition_service_app     | ##              | |                               ##
schema_composition_service_app     | ##              |_|                               ##
schema_composition_service_app     | ##                                                ## 
schema_composition_service_app     | ##  Get documentation at docs.liquibase.com       ##
schema_composition_service_app     | ##  Get certified courses at learn.liquibase.com  ## 
schema_composition_service_app     | ##  Free schema change activity reports at        ##
schema_composition_service_app     | ##      https://hub.liquibase.com                 ##
schema_composition_service_app     | ##                                                ##
schema_composition_service_app     | ####################################################
schema_composition_service_app     | Starting Liquibase at 03:53:26 (version 4.21.1 #9070 built at 2023-04-13 20:56+0000)
schema_composition_service_app     | Liquibase Version: 4.21.1
schema_composition_service_app     | Liquibase Open Source 4.21.1 by Liquibase
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | -- Lock Database
schema_composition_service_app     | UPDATE schema_composition.databasechangeloglock SET LOCKED = TRUE, LOCKEDBY = '1ee3994ad51c (172.30.0.7)', LOCKGRANTED = NOW() WHERE ID = 1 AND LOCKED = FALSE;
schema_composition_service_app     | 
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | -- *********************************************************************
schema_composition_service_app     | -- Update Database Script
schema_composition_service_app     | -- *********************************************************************
schema_composition_service_app     | -- Change Log: migrations/liquibase/changelog-root.xml
schema_composition_service_app     | -- Ran at: 1/15/26, 3:53â€¯AM
schema_composition_service_app     | -- Against: supabase_admin@jdbc:postgresql://db:5432/schema_composition_db
schema_composition_service_app     | -- Liquibase version: 4.21.1
schema_composition_service_app     | -- *********************************************************************
schema_composition_service_app     | 
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | -- Changeset migrations/liquibase/sql/001_init_schema.sql::raw::includeAll
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Updated Schema Composition DDL Marketplace-Grade Hardening and Additions
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | --
schema_composition_service_app     | -- This script inlines the original form_schema.sql and augments it with
schema_composition_service_app     | -- marketplace-grade hardening. Corrections include missing constraints,
schema_composition_service_app     | -- tenant-safe foreign keys, additional indexes for common access patterns,
schema_composition_service_app     | -- verbose documentation, provenance metadata columns, stable instance
schema_composition_service_app     | -- identifiers for embedded component placements, and deterministic JSONB
schema_composition_service_app     | -- merge utilities.
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Original schema definitions (inlined)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- BEGIN original form_schema.sql
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Dyno FROMs â€“ Field and Component Catalog Schema with Form Definitions
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- liquibase formatted sql
schema_composition_service_app     | -- changeset crm_service:002_support_domain_schema
schema_composition_service_app     | --
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --
schema_composition_service_app     | -- KEY ARCHITECTURE DECISIONS
schema_composition_service_app     | --
schema_composition_service_app     | -- SECURITY / TENANCY
schema_composition_service_app     | --
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | SET search_path TO public, schema_composition;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Dyno CRM - Field Catalog (Data Type vs Element Type)
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   These objects define reusable, tenant-scoped field definitions that
schema_composition_service_app     | --   can be used by tickets (and later by other entities).
schema_composition_service_app     | --
schema_composition_service_app     | --   This design separates:
schema_composition_service_app     | --     1) data_type    - the shape of the value stored (semantic type)
schema_composition_service_app     | --     2) element_type - how the field is rendered or behaves in the UI
schema_composition_service_app     | --
schema_composition_service_app     | --   IMPORTANT
schema_composition_service_app     | --     - ACTION is an element_type (behavior), not a data_type.
schema_composition_service_app     | --     - SELECT/MULTISELECT are element types; the underlying data is a
schema_composition_service_app     | --       reference to option keys (single value vs array).
schema_composition_service_app     | --
schema_composition_service_app     | -- NOTES
schema_composition_service_app     | --   - validation and ui_config are intentionally flexible JSONB blobs.
schema_composition_service_app     | --   - If you later want JSON schema enforcement, add CHECK constraints
schema_composition_service_app     | --     using public.jsonb_matches_schema(...) as you already do elsewhere.
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Enum: field_data_type
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines the semantic data shape stored for a field.
schema_composition_service_app     | --
schema_composition_service_app     | -- GUIDELINE
schema_composition_service_app     | --   Do not put UI widgets here (radio, checkbox, button, etc.).
schema_composition_service_app     | --   Those belong to field_element_type or ui_config.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | DO $$ BEGIN
schema_composition_service_app     |     CREATE TYPE schema_composition.field_data_type AS ENUM (
schema_composition_service_app     |         'TEXT',
schema_composition_service_app     |         'NUMBER',
schema_composition_service_app     |         'BOOLEAN',
schema_composition_service_app     |         'DATE',
schema_composition_service_app     |         'DATETIME',
schema_composition_service_app     |         'SINGLESELECT',  -- stores one option_key
schema_composition_service_app     |         'MULTISELECT'    -- stores an array of option_key values
schema_composition_service_app     |     );
schema_composition_service_app     | EXCEPTION WHEN duplicate_object THEN NULL;
schema_composition_service_app     | END $$;
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Enum: field_element_type
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines how the field is rendered or behaves in the UI.
schema_composition_service_app     | --
schema_composition_service_app     | -- NOTES
schema_composition_service_app     | --   - ACTION is a UI element that triggers behavior and does not store
schema_composition_service_app     | --     a value. When element_type=ACTION, data_type should be NULL.
schema_composition_service_app     | --   - SELECT/MULTISELECT represent UI widgets. Their stored data shape is
schema_composition_service_app     | --     described by field_data_type (SINGLESELECT/MULTISELECT).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | DO $$ BEGIN
schema_composition_service_app     |     CREATE TYPE schema_composition.field_element_type AS ENUM (
schema_composition_service_app     |         'TEXT',
schema_composition_service_app     |         'TEXTAREA',
schema_composition_service_app     |         'DATE',
schema_composition_service_app     |         'DATETIME',
schema_composition_service_app     |         'SELECT',
schema_composition_service_app     |         'MULTISELECT',
schema_composition_service_app     |         'ACTION'
schema_composition_service_app     |     );
schema_composition_service_app     | EXCEPTION WHEN duplicate_object THEN NULL;
schema_composition_service_app     | END $$;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Enum: artifact_source_type
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Classifies the provenance of a marketplace artifact installed for a tenant.
schema_composition_service_app     | DO $$ BEGIN
schema_composition_service_app     |     CREATE TYPE schema_composition.artifact_source_type AS ENUM (
schema_composition_service_app     |         'MARKETPLACE', 'PROVIDER', 'TENANT', 'SYSTEM'
schema_composition_service_app     |     );
schema_composition_service_app     | EXCEPTION WHEN duplicate_object THEN NULL;
schema_composition_service_app     | END $$;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_catalog_category
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Tenant-scoped category used to organize reusable form elements (field
schema_composition_service_app     | --   definitions and components) in builder UI palettes (accordion/grouping).
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - category_key:
schema_composition_service_app     | --       Stable tenant-scoped identifier used for import/export and integrations.
schema_composition_service_app     | --   - category_name:
schema_composition_service_app     | --       Human-readable label shown in builder UI.
schema_composition_service_app     | --   - is_active:
schema_composition_service_app     | --       Controls whether the category is available for selection/use in UI.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes categories to a tenant boundary.
schema_composition_service_app     | --   - category_key is unique per tenant.
schema_composition_service_app     | --   - category_name is unique per tenant (prevents confusing duplicates in UI).
schema_composition_service_app     | --   - updated_at is maintained by application code or a DB trigger (not included here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_catalog_category (
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     category_key VARCHAR(200) NOT NULL,  -- unique per tenant, stable identifier
schema_composition_service_app     |     category_name VARCHAR(50) NOT NULL,  -- unique per tenant, UI label
schema_composition_service_app     | 
schema_composition_service_app     |     description VARCHAR(200),
schema_composition_service_app     |     is_active BOOLEAN NOT NULL DEFAULT TRUE,
schema_composition_service_app     | 
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Supports tenant-safe composite foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_catalog_category_id_tenant 
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace identifiers.
schema_composition_service_app     |     CONSTRAINT ck_form_catalog_category_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(category_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_form_catalog_category_name_nonblank
schema_composition_service_app     |         CHECK (length(btrim(category_name)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable key uniqueness within tenant.
schema_composition_service_app     |     CONSTRAINT uq_form_catalog_category_tenant_key
schema_composition_service_app     |         UNIQUE (tenant_id, category_key),
schema_composition_service_app     | 
schema_composition_service_app     |     -- UI label uniqueness within tenant.
schema_composition_service_app     |     CONSTRAINT uq_form_catalog_category_tenant_name
schema_composition_service_app     |         UNIQUE (tenant_id, category_name)
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Common builder query: active categories per tenant.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_catalog_category_tenant_active
schema_composition_service_app     |     ON schema_composition.form_catalog_category (tenant_id, is_active);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: search by name in admin/builder UI.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_catalog_category_tenant_name_lower
schema_composition_service_app     |     ON schema_composition.form_catalog_category (tenant_id, lower(category_name));
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_catalog_category IS
schema_composition_service_app     | 'Tenant-scoped category used to organize reusable builder palette elements (field definitions and components). Intended for UI grouping (accordion) and marketplace browsing.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. Categories are tenant-scoped for isolation and customization.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.category_key IS
schema_composition_service_app     | 'Stable tenant-scoped identifier for the category (used for import/export and marketplace alignment).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.category_name IS
schema_composition_service_app     | 'Human-readable category label shown in builder UI (unique within tenant).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.description IS
schema_composition_service_app     | 'Optional description shown in admin/builder UI.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.is_active IS
schema_composition_service_app     | 'When true, category is available for selection/use in builder UI; when false it is hidden/disabled.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_catalog_category.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.field_def
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines a reusable field definition (catalog entry) for a tenant.
schema_composition_service_app     | --
schema_composition_service_app     | -- HOW THIS TABLE IS USED
schema_composition_service_app     | --   This table represents the canonical "catalog artifact" for a field, which can be:
schema_composition_service_app     | --     - placed into reusable components (composition layer snapshots it)
schema_composition_service_app     | --     - placed directly onto forms (composition layer snapshots it)
schema_composition_service_app     | --     - installed from provider defaults or marketplace packages (artifact import)
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   Artifact identity (versioned, immutable conceptually):
schema_composition_service_app     | --     - field_def_business_key + field_def_version defines the versioned identity
schema_composition_service_app     | --       of the catalog artifact within a tenant.
schema_composition_service_app     | --     - field_def_business_key is intended to be immutable after creation
schema_composition_service_app     | --       (immutability is typically enforced by application rules or a trigger).
schema_composition_service_app     | --
schema_composition_service_app     | --   Default key vs instance overrides:
schema_composition_service_app     | --     - field_key is a default/suggested key for the field definition.
schema_composition_service_app     | --     - field_key is NOT tenant-unique because downstream placements may override
schema_composition_service_app     | --       the effective field key/name in imprinted configs or placement overrides.
schema_composition_service_app     | --     - field_key remains nonblank and indexed for lookup/search.
schema_composition_service_app     | --
schema_composition_service_app     | --   Category grouping:
schema_composition_service_app     | --     - category_id optionally groups this field definition into a tenant-defined
schema_composition_service_app     | --       builder palette category (accordion grouping / catalog browsing).
schema_composition_service_app     | --
schema_composition_service_app     | --   Type system:
schema_composition_service_app     | --     - data_type describes the stored value shape (semantic type).
schema_composition_service_app     | --     - element_type describes UI rendering/behavior.
schema_composition_service_app     | --
schema_composition_service_app     | -- ACTION ELEMENTS
schema_composition_service_app     | --   - element_type = ACTION means this entry is an action/button element,
schema_composition_service_app     | --     not a data-capturing field.
schema_composition_service_app     | --   - For ACTION elements:
schema_composition_service_app     | --       * data_type MUST be NULL
schema_composition_service_app     | --       * validation SHOULD be NULL
schema_composition_service_app     | --       * ui_config contains action configuration (what it does)
schema_composition_service_app     | --
schema_composition_service_app     | -- NON-ACTION ELEMENTS
schema_composition_service_app     | --   - element_type != ACTION means this entry captures data.
schema_composition_service_app     | --   - For non-action elements:
schema_composition_service_app     | --       * data_type MUST be NOT NULL
schema_composition_service_app     | --
schema_composition_service_app     | -- SELECT / MULTISELECT
schema_composition_service_app     | --   - element_type SELECT      -> data_type must be SINGLESELECT
schema_composition_service_app     | --   - element_type MULTISELECT -> data_type must be MULTISELECT
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.field_def (
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Versioned artifact identity (tenant-scoped)
schema_composition_service_app     |     field_def_business_key VARCHAR(400) NOT NULL,
schema_composition_service_app     |     field_def_version INTEGER NOT NULL DEFAULT 1,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Human-readable name for admin/catalog UI.
schema_composition_service_app     |     name VARCHAR(100) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Human-readable description for admin/catalog UI.
schema_composition_service_app     |     description VARCHAR(1000),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Default/suggested key for the field definition.
schema_composition_service_app     |     -- NOTE: This is NOT tenant-unique. Placements may override the effective key.
schema_composition_service_app     |     field_key VARCHAR(100) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Human-readable label shown in UI.
schema_composition_service_app     |     label VARCHAR(255) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional category used by builder UI to group fields in palettes (accordion).
schema_composition_service_app     |     category_id UUID,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Semantic data shape stored for this field.
schema_composition_service_app     |     -- NULL only when element_type=ACTION.
schema_composition_service_app     |     data_type schema_composition.field_data_type,
schema_composition_service_app     | 
schema_composition_service_app     |     -- UI element type for rendering / behavior.
schema_composition_service_app     |     element_type schema_composition.field_element_type NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSON configuration for validation rules (data fields only).
schema_composition_service_app     |     validation JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSON configuration for UI hints and behavior.
schema_composition_service_app     |     -- For ACTION elements, contains action configuration.
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     is_published BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     published_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     is_archived BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     archived_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Provenance / source metadata (artifact origin)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Identifies the origin of this artifact at the time it was created
schema_composition_service_app     |     -- or installed into the tenant space.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This value distinguishes whether the artifact originated from:
schema_composition_service_app     |     --   - the built-in system catalog
schema_composition_service_app     |     --   - a provider-distributed default set
schema_composition_service_app     |     --   - a marketplace package
schema_composition_service_app     |     --   - or was created locally by the tenant
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   - SYSTEM       (platform-internal artifact)
schema_composition_service_app     |     --   - PROVIDER     (default artifact shipped by the service owner)
schema_composition_service_app     |     --   - MARKETPLACE  (installed from the public or private marketplace)
schema_composition_service_app     |     --   - TENANT       (created directly within the tenant environment)
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - builder palette filtering and grouping
schema_composition_service_app     |     --   - governance and permission enforcement
schema_composition_service_app     |     --   - upgrade and compatibility workflows
schema_composition_service_app     |     --   - artifact lifecycle management
schema_composition_service_app     |     --   - support, audit, and operational diagnostics
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This value is set at creation or install time and should be treated
schema_composition_service_app     |     -- as immutable for the lifetime of the artifact.
schema_composition_service_app     |     source_type schema_composition.artifact_source_type,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Provenance / source metadata (immutable imports)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Identifies the package from which this field definition was installed.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   - marketplace package key
schema_composition_service_app     |     --   - provider-distributed bundle identifier
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - lineage tracking
schema_composition_service_app     |     --   - dependency resolution
schema_composition_service_app     |     --   - uninstall / upgrade orchestration
schema_composition_service_app     |     --   - support and audit diagnostics
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This value is immutable once installed.
schema_composition_service_app     |     source_package_key VARCHAR(400),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Identifies the specific artifact within the source package.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This is the stable identity of the field definition *inside* the package,
schema_composition_service_app     |     -- independent of tenant-local UUIDs.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - mapping installed artifacts back to their catalog definitions
schema_composition_service_app     |     --   - matching upgrade candidates
schema_composition_service_app     |     --   - detecting duplicate installs
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This value is immutable once installed.
schema_composition_service_app     |     source_artifact_key VARCHAR(400),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Version identifier of the source artifact at the time of installation.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This is a publisher-controlled version string (not necessarily numeric),
schema_composition_service_app     |     -- such as:
schema_composition_service_app     |     --   - "1.0.0"
schema_composition_service_app     |     --   - "2024.10"
schema_composition_service_app     |     --   - "v3"
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - upgrade eligibility checks
schema_composition_service_app     |     --   - compatibility validation
schema_composition_service_app     |     --   - reproducibility and audit
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This value represents the installed version and does not change unless
schema_composition_service_app     |     -- the artifact is explicitly upgraded.
schema_composition_service_app     |     source_artifact_version VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Cryptographic checksum (typically SHA-256 hex) of the source artifact
schema_composition_service_app     |     -- content at install time.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - integrity verification
schema_composition_service_app     |     --   - detecting publisher-side changes without version bumps
schema_composition_service_app     |     --   - reproducible installs
schema_composition_service_app     |     --   - forensic and support analysis
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Because imported artifacts are immutable, this checksum represents
schema_composition_service_app     |     -- both the source and effective content.
schema_composition_service_app     |     source_checksum VARCHAR(64),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Timestamp when this field definition artifact was installed into the tenant.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used for:
schema_composition_service_app     |     --   - audit trails
schema_composition_service_app     |     --   - support diagnostics
schema_composition_service_app     |     --   - upgrade sequencing
schema_composition_service_app     |     --   - lifecycle analysis
schema_composition_service_app     |     installed_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Identifier of the actor (user, service, or automation) that performed
schema_composition_service_app     |     -- the installation.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   - admin username
schema_composition_service_app     |     --   - system bootstrap service
schema_composition_service_app     |     --   - marketplace installer service
schema_composition_service_app     |     installed_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Supports tenant-safe composite foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_field_def_id_tenant UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Versioned artifact identity must be unique per tenant.
schema_composition_service_app     |     CONSTRAINT uq_field_def_tenant_business_key_version
schema_composition_service_app     |         UNIQUE (tenant_id, field_def_business_key, field_def_version),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK to builder palette category.
schema_composition_service_app     |     CONSTRAINT fk_field_def_category_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, category_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_catalog_category (tenant_id, id)
schema_composition_service_app     |         ON DELETE SET NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Business key must not be blank/whitespace.
schema_composition_service_app     |     CONSTRAINT ck_field_def_business_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(field_def_business_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Version must be positive.
schema_composition_service_app     |     CONSTRAINT ck_field_def_version_positive
schema_composition_service_app     |         CHECK (field_def_version >= 1),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace field_key.
schema_composition_service_app     |     CONSTRAINT chk_field_def_field_key_not_blank
schema_composition_service_app     |         CHECK (length(btrim(field_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace label.
schema_composition_service_app     |     CONSTRAINT chk_field_def_label_not_blank
schema_composition_service_app     |         CHECK (length(btrim(label)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce ACTION vs non-ACTION semantics.
schema_composition_service_app     |     CONSTRAINT chk_field_def_action_requires_no_data_type
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (element_type = 'ACTION' AND data_type IS NULL)
schema_composition_service_app     |             OR
schema_composition_service_app     |             (element_type <> 'ACTION' AND data_type IS NOT NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce SELECT pairing between element_type and data_type.
schema_composition_service_app     |     CONSTRAINT chk_field_def_select_data_type_alignment
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (element_type = 'SELECT' AND data_type = 'SINGLESELECT')
schema_composition_service_app     |             OR
schema_composition_service_app     |             (element_type = 'MULTISELECT' AND data_type = 'MULTISELECT')
schema_composition_service_app     |             OR
schema_composition_service_app     |             (element_type NOT IN ('SELECT', 'MULTISELECT'))
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_field_def_source_checksum_format
schema_composition_service_app     |         CHECK (source_checksum IS NULL OR source_checksum ~ '^[0-9a-f]{64}$')
schema_composition_service_app     | 
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Lookup/filter by default field key within tenant (NOT unique).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_field_key
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, field_key);
schema_composition_service_app     | 
schema_composition_service_app     | -- Builder palette filtering: list field defs by tenant and category.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_category
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, category_id)
schema_composition_service_app     |     WHERE category_id IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | -- Common catalog filtering: list field defs by tenant and element type.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_element_type
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, element_type);
schema_composition_service_app     | 
schema_composition_service_app     | -- Common catalog filtering: list field defs by tenant and data type.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_data_type
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, data_type)
schema_composition_service_app     |     WHERE data_type IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: search by label in admin UI.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_label
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, lower(label));
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: search within category by label in builder UI.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_category_label
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, category_id, lower(label))
schema_composition_service_app     |     WHERE category_id IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_source_type
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, source_type);
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_tenant_source_keys
schema_composition_service_app     |     ON schema_composition.field_def (tenant_id, source_package_key, source_artifact_key, source_artifact_version);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.field_def IS
schema_composition_service_app     | 'Reusable tenant-scoped field definition catalog artifact. Supports versioned artifact identity (field_def_business_key + field_def_version) for safe evolution and marketplace alignment. field_key is a default/suggested key that may be overridden at placement time and is therefore not tenant-unique.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All field definitions are tenant-scoped for isolation, access control, and customization.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.field_def_business_key IS
schema_composition_service_app     | 'Versioned artifact identity key (tenant-scoped). Intended to be immutable after creation. Used to align installs/upgrades across provider/marketplace packages. Uniqueness is enforced together with field_def_version per tenant.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.field_def_version IS
schema_composition_service_app     | 'Version number for the artifact identified by (tenant_id, field_def_business_key). Must be >= 1. New versions represent new releases of the same conceptual field definition.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.name IS
schema_composition_service_app     | 'Human-readable internal/admin name for the field definition (catalog display).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.description IS
schema_composition_service_app     | 'Optional human-readable description for catalog/admin tooling.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.field_key IS
schema_composition_service_app     | 'Default/suggested key for this field definition. Used as a starting point for builder/runtime, but may be overridden in placement-level configs or imprinted snapshots; therefore it is NOT tenant-unique. Indexed for lookup/filtering.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.label IS
schema_composition_service_app     | 'Human-readable label shown in UI by default. Placements may override label in imprinted configs/overrides.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.category_id IS
schema_composition_service_app     | 'Optional reference to schema_composition.form_catalog_category used to group field definitions in builder palette UI (accordion/categories). Tenant-local classification only.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.data_type IS
schema_composition_service_app     | 'Semantic data shape stored for this field. Must be NULL only when element_type is ACTION; otherwise required.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.element_type IS
schema_composition_service_app     | 'UI rendering/behavior type for this field definition (TEXT, TEXTAREA, SELECT, ACTION, etc.).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.validation IS
schema_composition_service_app     | 'Optional JSONB validation rules for data-capturing fields. Typically NULL for ACTION elements.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.ui_config IS
schema_composition_service_app     | 'Optional JSONB UI hints and behavior configuration. For ACTION elements, contains action configuration (what the action does).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.is_published IS
schema_composition_service_app     | 'When true, field definition is available in catalog/builder surfaces for selection/use.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.published_at IS
schema_composition_service_app     | 'Timestamp when the field definition was published (if tracked by application/workflow).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.is_archived IS
schema_composition_service_app     | 'When true, field definition is archived and should not be offered for new use, but is retained for history/back-compat.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.archived_at IS
schema_composition_service_app     | 'Timestamp when the field definition was archived (if tracked by application/workflow).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | ----
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.field_def.source_type IS
schema_composition_service_app     | 'Identifies the origin of this artifact at creation or installation time. Distinguishes system-provided, provider-distributed, marketplace-installed, and tenant-created artifacts. Used for governance, builder palette filtering, upgrade and compatibility workflows, lifecycle management, and audit diagnostics. This value is intended to be immutable once set.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: field_def_option
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines the allowed options for SELECT / MULTISELECT ticket fields.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Each option belongs to exactly one field_def.
schema_composition_service_app     | --   - option_key is a stable key for API payloads and integrations.
schema_composition_service_app     | --   - option_label is the UI display value.
schema_composition_service_app     | --   - option_order controls UI ordering.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT
schema_composition_service_app     | --   - Options are only semantically valid when field_type is SELECT or
schema_composition_service_app     | --     MULTISELECT. Enforcing that strictly at the DB level requires a
schema_composition_service_app     | --     trigger (because it depends on the parent row's field_type).
schema_composition_service_app     | --   - This table still enforces strong tenant-safe FK integrity and
schema_composition_service_app     | --     uniqueness within a field definition.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.field_def_option (
schema_composition_service_app     |     -- Composite identity: options are tenant-scoped and belong to a field.
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     |     field_def_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable key used in API values (preferred over display text).
schema_composition_service_app     |     -- Example: "high", "medium", "low"
schema_composition_service_app     |     option_key VARCHAR(200) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Display value shown in UI.
schema_composition_service_app     |     -- Example: "High", "Medium", "Low"
schema_composition_service_app     |     option_label VARCHAR(400) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Controls ordering in dropdown/multi-select UI.
schema_composition_service_app     |     option_order INTEGER NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Composite primary key for the option row.
schema_composition_service_app     |     CONSTRAINT pk_field_def_option PRIMARY KEY (tenant_id, field_def_id, option_key),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK back to the field definition.
schema_composition_service_app     |     CONSTRAINT fk_field_def_option_field_def
schema_composition_service_app     |         FOREIGN KEY (tenant_id, field_def_id)
schema_composition_service_app     |         REFERENCES schema_composition.field_def (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE
schema_composition_service_app     |         DEFERRABLE INITIALLY DEFERRED,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace keys.
schema_composition_service_app     |     CONSTRAINT chk_field_def_option_key_not_blank
schema_composition_service_app     |         CHECK (length(btrim(option_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace values.
schema_composition_service_app     |     CONSTRAINT chk_field_def_option_label_not_blank
schema_composition_service_app     |         CHECK (length(btrim(option_label)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- option_order should be non-negative (0-based or 1-based both allowed).
schema_composition_service_app     |     CONSTRAINT chk_field_def_option_order_non_negative
schema_composition_service_app     |         CHECK (option_order >= 0)
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- Ensure option_order is unique within a field definition (stable ordering).
schema_composition_service_app     | CREATE UNIQUE INDEX IF NOT EXISTS ux_field_def_option_order
schema_composition_service_app     |     ON schema_composition.field_def_option (tenant_id, field_def_id, option_order);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: look up by display value (useful for admin search, rarely needed).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_field_def_option_label
schema_composition_service_app     |     ON schema_composition.field_def_option (tenant_id, lower(option_label));
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.component
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Represents a reusable, catalog-style "component" that can be added to a form panel.
schema_composition_service_app     | --   Components are intended to be sourced from:
schema_composition_service_app     | --     - provider preloaded components (tenant-owned by provider or seeded per-tenant)
schema_composition_service_app     | --     - marketplace components (distributed templates/components)
schema_composition_service_app     | --     - tenant-defined components (tenant-created)
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Business identity vs. row identity:
schema_composition_service_app     | --       * id is the immutable row identifier (UUID PK).
schema_composition_service_app     | --       * component_business_key + component_version provides a stable catalog identity for
schema_composition_service_app     | --         versioned releases of the same conceptual component.
schema_composition_service_app     | --   - Stable key vs. UI label:
schema_composition_service_app     | --       * component_key is a stable, tenant-scoped identifier used in APIs/automation.
schema_composition_service_app     | --       * component_label is the user-facing label shown in UI.
schema_composition_service_app     | --   - category_id optionally groups this component into a tenant-defined builder palette
schema_composition_service_app     | --     category (accordion grouping / catalog browsing).
schema_composition_service_app     | --   - ui_config is intentionally flexible JSONB for UI hints and runtime behavior.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes all data to a tenant boundary.
schema_composition_service_app     | --   - component_key is unique per tenant (stable identifier).
schema_composition_service_app     | --   - component_business_key + component_version is unique per tenant (versioned identity).
schema_composition_service_app     | --   - category_id (when present) must reference a category in the same tenant.
schema_composition_service_app     | --   - Publishing / archiving timestamps are consistent with their flags:
schema_composition_service_app     | --       * is_published = true  => published_at is not null
schema_composition_service_app     | --       * is_published = false => published_at is null
schema_composition_service_app     | --       * is_archived = true   => archived_at is not null
schema_composition_service_app     | --       * is_archived = false  => archived_at is null
schema_composition_service_app     | --   - updated_at is maintained by application code or a DB trigger (not included here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.component (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant boundary. This table is always tenant-scoped.
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Catalog identity (versioning)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Stable "catalog/business" key used to identify a component across versions
schema_composition_service_app     |     -- within the same tenant (and potentially across tenants via marketplace import).
schema_composition_service_app     |     component_business_key VARCHAR(400) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Monotonic version number for a given (tenant_id, component_business_key).
schema_composition_service_app     |     -- Typically starts at 1.
schema_composition_service_app     |     component_version INTEGER NOT NULL DEFAULT 1,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Human-facing metadata (admin/catalog UI)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     name VARCHAR(100) NOT NULL,
schema_composition_service_app     |     description VARCHAR(1000),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Stable runtime identifier (tenant-scoped)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Stable key used by systems/integrations. Example: "priority", "customer_email".
schema_composition_service_app     |     component_key VARCHAR(100) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- UI label shown to end users (optional; some components may render without a label).
schema_composition_service_app     |     component_label VARCHAR(255),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional category used by builder UI to group components in palettes (accordion).
schema_composition_service_app     |     -- This is a tenant-local classification and does not affect runtime semantics.
schema_composition_service_app     |     category_id UUID,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- UI and behavior configuration
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Flexible JSONB for UI hints, rendering instructions, and optional runtime behavior.
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   { "placeholder": "Enter value", "help_text": "...", "render_as": "radio" }
schema_composition_service_app     |     --   { "action_type": "WORKFLOW_TRANSITION", "transition_key": "approve" }
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Lifecycle / catalog availability
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Published means "available for use/selection" in the catalog surface.
schema_composition_service_app     |     -- Default TRUE (most components are usable when created).
schema_composition_service_app     |     is_published BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     published_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archived means "no longer actively offered" but retained for history/back-compat.
schema_composition_service_app     |     -- Default should be FALSE for newly created components (fixed from TRUE).
schema_composition_service_app     |     is_archived BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     archived_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     source_type schema_composition.artifact_source_type,
schema_composition_service_app     |     source_package_key VARCHAR(400),
schema_composition_service_app     |     source_artifact_key VARCHAR(400),
schema_composition_service_app     |     source_artifact_version VARCHAR(100),
schema_composition_service_app     |     source_checksum VARCHAR(64),
schema_composition_service_app     |     installed_at TIMESTAMPTZ,
schema_composition_service_app     |     installed_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ux_component_id_tenant 
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Ensure version is sensible.
schema_composition_service_app     |     CONSTRAINT ck_component_version_positive
schema_composition_service_app     |         CHECK (component_version >= 1),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent empty/whitespace-only keys (defensive; trims are app-level too).
schema_composition_service_app     |     CONSTRAINT ck_component_business_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(component_business_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_component_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(component_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_component_name_nonblank
schema_composition_service_app     |         CHECK (length(btrim(name)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK to builder palette category.
schema_composition_service_app     |     -- Requires a UNIQUE/PK on schema_composition.form_catalog_category(tenant_id, id) or equivalent.
schema_composition_service_app     |     CONSTRAINT fk_component_category_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, category_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_catalog_category (tenant_id, id)
schema_composition_service_app     |         ON DELETE SET NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Publishing timestamp must align with the published flag.
schema_composition_service_app     |     CONSTRAINT ck_component_published_at_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_published = TRUE  AND published_at IS NOT NULL)
schema_composition_service_app     |          OR (is_published = FALSE AND published_at IS NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archiving timestamp must align with the archived flag.
schema_composition_service_app     |     CONSTRAINT ck_component_archived_at_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_archived = TRUE  AND archived_at IS NOT NULL)
schema_composition_service_app     |          OR (is_archived = FALSE AND archived_at IS NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Versioned catalog identity within tenant.
schema_composition_service_app     |     CONSTRAINT uq_component_tenant_business_key_version
schema_composition_service_app     |         UNIQUE (tenant_id, component_business_key, component_version),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable runtime identity within tenant.
schema_composition_service_app     |     CONSTRAINT uq_component_tenant_component_key_version
schema_composition_service_app     |         UNIQUE (tenant_id, component_key, component_version),
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_component_source_checksum_format
schema_composition_service_app     |         CHECK (source_checksum IS NULL OR source_checksum ~ '^[0-9a-f]{64}$')
schema_composition_service_app     | 
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_source_type
schema_composition_service_app     |     ON schema_composition.component (tenant_id, source_type);
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_source_keys
schema_composition_service_app     |     ON schema_composition.component (tenant_id, source_package_key, source_artifact_key, source_artifact_version);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Primary lookup patterns:
schema_composition_service_app     | --   - list components for a tenant (optionally only published / not archived)
schema_composition_service_app     | --   - resolve by component_key (unique) or by (business_key, version)
schema_composition_service_app     | --   - search/browse by name within tenant
schema_composition_service_app     | --   - filter by published/archived state within tenant
schema_composition_service_app     | --   - builder palette filtering by category
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Builder palette filtering: list components by tenant and category.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_category
schema_composition_service_app     |     ON schema_composition.component (tenant_id, category_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Browse/search by name within tenant (supports prefix/ordering use cases).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_name
schema_composition_service_app     |     ON schema_composition.component (tenant_id, name);
schema_composition_service_app     | 
schema_composition_service_app     | -- Supports "catalog" listing filters quickly (tenant + lifecycle flags).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_catalog_state
schema_composition_service_app     |     ON schema_composition.component (tenant_id, is_published, is_archived);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: search within category by name in builder UI.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_tenant_category_name
schema_composition_service_app     |     ON schema_composition.component (tenant_id, category_id, name)
schema_composition_service_app     |     WHERE category_id IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Column Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.component IS
schema_composition_service_app     | 'Reusable, tenant-scoped form component. Supports provider/marketplace seeding and tenant-defined components. Includes stable keys, versioning, optional builder category assignment, UI config, publish/archive lifecycle, and audit fields.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All component rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.component_business_key IS
schema_composition_service_app     | 'Stable catalog/business identifier for the conceptual component. Used with component_version to represent versioned releases of the same component within a tenant (and across tenants via marketplace import).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.component_version IS
schema_composition_service_app     | 'Version number for a given (tenant_id, component_business_key). Starts at 1 and increments for new releases.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.name IS
schema_composition_service_app     | 'Human-readable name used in admin/catalog UI. Not required to be unique.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.description IS
schema_composition_service_app     | 'Optional human-readable description for admin/catalog UI.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.component_key IS
schema_composition_service_app     | 'Stable tenant-scoped key used by APIs, automations, and references from other tables. Unique within tenant.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.component_label IS
schema_composition_service_app     | 'Human-readable label shown in end-user UI. Optional; some components may not render a label.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.category_id IS
schema_composition_service_app     | 'Optional reference to schema_composition.form_catalog_category for grouping components in the builder palette UI (accordion/categories). Tenant-local classification only.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.ui_config IS
schema_composition_service_app     | 'JSONB configuration for UI hints and behavior (rendering options, help text, action config, etc.).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.is_published IS
schema_composition_service_app     | 'When true, component is available for selection/use in catalog surfaces. When false, it is hidden/unavailable (but may still exist for history).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.published_at IS
schema_composition_service_app     | 'Timestamp when the component was published. Must be non-null only when is_published is true.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.is_archived IS
schema_composition_service_app     | 'When true, component is archived (retained for history/back-compat but not actively offered).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.archived_at IS
schema_composition_service_app     | 'Timestamp when the component was archived. Must be non-null only when is_archived is true.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.source_type IS
schema_composition_service_app     |     'Provenance classification of the artifact installation. Allowed values: MARKETPLACE, PROVIDER, TENANT, SYSTEM.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.source_package_key IS
schema_composition_service_app     |     'Key identifying the package from which this component artifact originated (e.g., marketplace or provider package).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.source_artifact_key IS
schema_composition_service_app     |     'Key identifying the specific artifact within the source package.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.source_artifact_version IS
schema_composition_service_app     |     'Version string of the source artifact from which this component was installed.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.source_checksum IS
schema_composition_service_app     |     'SHA-256 checksum (64 hex characters) of the source artifact at install time. Used to detect source changes and upgrade eligibility.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.installed_at IS
schema_composition_service_app     |     'Timestamp when this component artifact was installed for the tenant.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.installed_by IS
schema_composition_service_app     |     'Actor (username/service) that installed this component artifact.';
schema_composition_service_app     |     
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.component_panel
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines a panel within a reusable component.
schema_composition_service_app     | --   A panel is a logical + visual segment used to group fields and/or nested panels.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Hierarchy:
schema_composition_service_app     | --       Panels can nest via parent_panel_id, forming a tree under a component.
schema_composition_service_app     | --       Root panels have parent_panel_id = NULL.
schema_composition_service_app     | --   - Stable identity:
schema_composition_service_app     | --       panel_key is a stable, tenant-scoped identifier used by APIs and references.
schema_composition_service_app     | --       panel_label is a user-facing label shown in UI.
schema_composition_service_app     | --   - ui_config:
schema_composition_service_app     | --       JSONB for layout/styling/behavior hints (think "panel container" hints, not business data).
schema_composition_service_app     | --   - panel_actions:
schema_composition_service_app     | --       JSONB declarative rules that define reactive behavior between fields, panels,
schema_composition_service_app     | --       and components contained within this panel.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - component_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - parent_panel_id (when present) must:
schema_composition_service_app     | --       * exist
schema_composition_service_app     | --       * belong to the same tenant_id
schema_composition_service_app     | --       * belong to the same component_id
schema_composition_service_app     | --   - panel_key is unique per (tenant_id, component_id).
schema_composition_service_app     | --   - A panel cannot parent itself.
schema_composition_service_app     | --   - updated_at is maintained by application code or a DB trigger (not included here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.component_panel (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary and owning component
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The component this panel belongs to.
schema_composition_service_app     |     component_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Parent component panel (null if root panel).
schema_composition_service_app     |     parent_panel_id UUID,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable key for referencing this panel within the component.
schema_composition_service_app     |     -- Intended for APIs, templates, and deterministic lookup.
schema_composition_service_app     |     panel_key VARCHAR(200) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Human-readable label shown in UI.
schema_composition_service_app     |     panel_label VARCHAR(200),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSON UI configuration (layout/styling/behavior hints).
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   { "layout": "two_column", "css": {"gap": "12px"}, "collapsible": true }
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Panel interaction rules
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Declarative JSON rules that define reactive behavior between fields,
schema_composition_service_app     |     -- panels, and components contained within this panel.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Intended use cases:
schema_composition_service_app     |     --   - Toggle visibility or enabled/required state of fields or panels
schema_composition_service_app     |     --     based on changes in other fields (e.g. checkbox on/off).
schema_composition_service_app     |     --   - Switch between mutually exclusive panels or component variants
schema_composition_service_app     |     --     based on selected option values.
schema_composition_service_app     |     --   - Coordinate simple UI state changes without embedding executable code.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Expected characteristics:
schema_composition_service_app     |     --   - Declarative (no scripts or expressions).
schema_composition_service_app     |     --   - References targets and sources by stable keys (panel_key, field_key,
schema_composition_service_app     |     --     component_key), never labels.
schema_composition_service_app     |     --   - Schema-validated and interpreted by application/UI logic.
schema_composition_service_app     |     panel_actions JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Ensure tenantâ€‘safe unique constraints
schema_composition_service_app     |     CONSTRAINT ux_component_panel_id_tenant 
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- unique constraint for parent panels to support FK fk_component_panel_parent_panel_tenant_component
schema_composition_service_app     |     CONSTRAINT ux_component_panel_tenant_component_id 
schema_composition_service_app     |         UNIQUE (tenant_id, component_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce hierarchical integrity for component panels.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This self-referencing foreign key guarantees that when a panel declares a
schema_composition_service_app     |     -- parent_panel_id, that parent:
schema_composition_service_app     |     --   1) EXISTS (referential integrity)
schema_composition_service_app     |     --   2) Belongs to the SAME tenant (tenant_id match)
schema_composition_service_app     |     --   3) Belongs to the SAME component (component_id match)
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Why component_id is intentionally included:
schema_composition_service_app     |     --   Panels form a tree that is strictly scoped to a single component.
schema_composition_service_app     |     --   A panel must NEVER be allowed to parent a panel from a different component,
schema_composition_service_app     |     --   even if they belong to the same tenant.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Using a simplified FK on (tenant_id, parent_panel_id) would be insufficient,
schema_composition_service_app     |     -- because it would allow cross-component parenting within the same tenant.
schema_composition_service_app     |     -- That would violate the core domain invariant and could corrupt the panel tree.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Performance tradeoff:
schema_composition_service_app     |     --   This table is not write-heavy, and panel hierarchy changes are relatively rare
schema_composition_service_app     |     --   compared to read operations. The additional column in the FK and supporting
schema_composition_service_app     |     --   index has negligible impact on performance, while providing strong correctness
schema_composition_service_app     |     --   guarantees enforced directly by the database.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- ON DELETE CASCADE is intentional:
schema_composition_service_app     |     --   Deleting a parent panel deletes its entire subtree, which matches the
schema_composition_service_app     |     --   ownership semantics of component panels.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Correctness and invariant enforcement are prioritized over marginal FK
schema_composition_service_app     |     -- simplification or micro-optimizations.
schema_composition_service_app     |     CONSTRAINT fk_component_panel_parent_panel_tenant_component 
schema_composition_service_app     |         FOREIGN KEY (tenant_id, component_id, parent_panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.component_panel (tenant_id, component_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: prevent empty/whitespace-only keys.
schema_composition_service_app     |     CONSTRAINT ck_component_panel_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(panel_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: prevent empty/whitespace-only label if provided.
schema_composition_service_app     |     CONSTRAINT ck_component_panel_label_nonblank
schema_composition_service_app     |         CHECK (panel_label IS NULL OR length(btrim(panel_label)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent self-parenting.
schema_composition_service_app     |     CONSTRAINT ck_component_panel_no_self_parent
schema_composition_service_app     |         CHECK (parent_panel_id IS NULL OR parent_panel_id <> id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable identity within a component.
schema_composition_service_app     |     CONSTRAINT uq_component_panel_tenant_component_panel_key
schema_composition_service_app     |         UNIQUE (tenant_id, component_id, panel_key),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK: forces component_id to belong to same tenant_id.
schema_composition_service_app     |     -- Requires a UNIQUE/PK on schema_composition.component(tenant_id, id) or equivalent.
schema_composition_service_app     |     CONSTRAINT fk_component_panel_component_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, component_id)
schema_composition_service_app     |         REFERENCES schema_composition.component (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Common access patterns:
schema_composition_service_app     | --   - list panels for a component (and build a tree)
schema_composition_service_app     | --   - fetch children for a given parent_panel_id
schema_composition_service_app     | --   - resolve by (tenant_id, component_id, panel_key)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fetch children by parent quickly (tree traversal).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_panel_parent
schema_composition_service_app     |     ON schema_composition.component_panel (tenant_id, component_id, parent_panel_id);
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional but useful when ordering/recency queries exist.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_panel_tenant_component_updated_at
schema_composition_service_app     |     ON schema_composition.component_panel (tenant_id, component_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.component_panel IS
schema_composition_service_app     | 'Panel within a reusable component. Panels are hierarchical (parent_panel_id) and group fields or nested panels. Includes declarative panel-level interaction rules via panel_actions. Tenant-scoped and component-scoped with tenant-safe foreign keys.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All panel rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.component_id IS
schema_composition_service_app     | 'Owning component ID. Panel belongs to exactly one component.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.parent_panel_id IS
schema_composition_service_app     | 'Optional parent panel ID for nesting. NULL indicates a root panel within the component. Parent must be in the same tenant and component.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.panel_key IS
schema_composition_service_app     | 'Stable identifier for this panel within (tenant_id, component_id). Used by APIs/templates and for deterministic lookup.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.panel_label IS
schema_composition_service_app     | 'Human-readable label shown in UI. Optional.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.ui_config IS
schema_composition_service_app     | 'JSONB UI configuration for layout, styling, and container-level rendering hints.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.panel_actions IS
schema_composition_service_app     | 'JSONB declarative interaction rules that define how fields, panels, and component variants within this panel react to user input and state changes.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.component_panel_field
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines the placement of a reusable field definition (field_def) onto a
schema_composition_service_app     | --   specific component panel. This table is the "composition" layer that:
schema_composition_service_app     | --     - attaches a field_def to a panel (provenance / reset source)
schema_composition_service_app     | --     - defines the display order of the field within that panel
schema_composition_service_app     | --     - allows per-panel overrides of the field_def UI configuration
schema_composition_service_app     | --     - stores an imprinted, editable field configuration snapshot (field_config)
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Composition (panel + field_def):
schema_composition_service_app     | --       A panel contains zero or more fields. Each row represents one field instance
schema_composition_service_app     | --       placed on that panel, backed by a reusable field_def.
schema_composition_service_app     | --   - Ordering:
schema_composition_service_app     | --       field_order controls default tab / display ordering within the panel.
schema_composition_service_app     | --       Ordering is panel-scoped (not global).
schema_composition_service_app     | --   - UI configuration overrides:
schema_composition_service_app     | --       field_def.ui_config is the base configuration.
schema_composition_service_app     | --       component_panel_field.ui_config is an override/augmentation applied in the
schema_composition_service_app     | --       context of this specific panel placement.
schema_composition_service_app     | --   - Imprinting (field_config):
schema_composition_service_app     | --       field_config is a JSONB snapshot that can fully represent the effective
schema_composition_service_app     | --       field_def and its options at the time the field was placed.
schema_composition_service_app     | --       Edits to the placed field update field_config, leaving field_def unchanged.
schema_composition_service_app     | --       A reset action can re-imprint field_config from the referenced field_def.
schema_composition_service_app     | --   - Hashing:
schema_composition_service_app     | --       * field_config_hash: hash of the current field_config JSONB (detect edits/diff).
schema_composition_service_app     | --       * source_field_def_hash: hash of the canonical source snapshot from field_def
schema_composition_service_app     | --         (field_def + field_def_option) at the time of imprint (detect catalog drift).
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - panel_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - field_def_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - A given (tenant_id, panel_id, field_def_id) should be unique to prevent
schema_composition_service_app     | --     accidental duplicate placement of the same field_def on the same panel.
schema_composition_service_app     | --   - field_order, when provided, must be >= 0.
schema_composition_service_app     | --   - field_config must conform to the JSON schema enforced by jsonb_matches_schema.
schema_composition_service_app     | --   - Hash columns are typically maintained by application logic or triggers.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.component_panel_field (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary and owning panel
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The component panel this field belongs to.
schema_composition_service_app     |     panel_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The field definition used as the source for this field placement.
schema_composition_service_app     |     -- This is provenance and reset source. The placed field's effective definition
schema_composition_service_app     |     -- lives in field_config (imprinted snapshot).
schema_composition_service_app     |     field_def_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Default display/tab order within the panel.
schema_composition_service_app     |     -- Null means "unspecified" (UI/service may apply a default ordering strategy).
schema_composition_service_app     |     field_order INTEGER,
schema_composition_service_app     | 
schema_composition_service_app     |     -- field_def has its own ui_config; ui_config here are overrides for this placement.
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Imprinted field definition snapshot
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- JSONB snapshot representing the effective field definition and options for this
schema_composition_service_app     |     -- placement. This is the editable copy that can diverge from the catalog field_def.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- The schema is enforced via public.jsonb_matches_schema(field_config, <schema>).
schema_composition_service_app     |     field_config JSONB NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Hash of the current field_config JSONB (typically sha256 hex, 64 chars).
schema_composition_service_app     |     -- Used to detect edits and support fast diff checks without deep JSON comparison.
schema_composition_service_app     |     field_config_hash VARCHAR(64),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Hash of the canonical source snapshot from field_def + field_def_option that was
schema_composition_service_app     |     -- used to imprint field_config initially (typically sha256 hex, 64 chars).
schema_composition_service_app     |     -- Used to detect when the catalog source changed since imprint (reset candidate).
schema_composition_service_app     |     source_field_def_hash VARCHAR(64),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Timestamp when field_config was last imprinted from the catalog source.
schema_composition_service_app     |     last_imprinted_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Ensure tenantâ€‘safe unique constraints
schema_composition_service_app     |     CONSTRAINT ux_component_panel_field_tenant_id
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: ordering, when provided, must be non-negative.
schema_composition_service_app     |     CONSTRAINT ck_component_panel_field_order_non_negative
schema_composition_service_app     |         CHECK (field_order IS NULL OR field_order >= 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent duplicate placement of the same field_def on the same panel.
schema_composition_service_app     |     CONSTRAINT uq_component_panel_field_panel_field_def
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, field_def_id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional: enforce a single field_order value per panel when field_order is used.
schema_composition_service_app     |     -- This helps prevent "two fields share order 10" ambiguity.
schema_composition_service_app     |     -- (Allows multiple NULLs.)
schema_composition_service_app     |     CONSTRAINT uq_component_panel_field_panel_order
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, field_order),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce hash formatting when provided (sha256 hex).
schema_composition_service_app     |     CONSTRAINT ck_component_panel_field_field_config_hash_format
schema_composition_service_app     |         CHECK (field_config_hash IS NULL OR field_config_hash ~ '^[0-9a-f]{64}$'),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_component_panel_field_source_field_def_hash_format
schema_composition_service_app     |         CHECK (source_field_def_hash IS NULL OR source_field_def_hash ~ '^[0-9a-f]{64}$'),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce field_config JSON schema.
schema_composition_service_app     |     -- NOTE: This assumes public.jsonb_matches_schema(instance_jsonb, schema_jsonb) exists.
schema_composition_service_app     |     CONSTRAINT ck_component_panel_field_field_config_schema
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             public.jsonb_matches_schema(
schema_composition_service_app     |                 $${
schema_composition_service_app     |                   "$schema": "http://json-schema.org/draft-07/schema#",
schema_composition_service_app     |                   "title": "DynoCRM Component Panel Field Config",
schema_composition_service_app     |                   "type": "object",
schema_composition_service_app     |                   "additionalProperties": false,
schema_composition_service_app     |                   "required": ["schema_version", "field"],
schema_composition_service_app     |                   "properties": {
schema_composition_service_app     |                     "schema_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     | 
schema_composition_service_app     |                     "field": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": false,
schema_composition_service_app     |                       "required": ["field_key", "label", "element_type"],
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "field_def_business_key": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                         "field_def_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "name": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "description": { "type": ["string", "null"], "maxLength": 1000 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "field_key": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "label": { "type": "string", "minLength": 1, "maxLength": 255 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "category_id": { "type": ["string", "null"], "pattern": "^[0-9a-fA-F-]{36}$" },
schema_composition_service_app     | 
schema_composition_service_app     |                         "data_type": {
schema_composition_service_app     |                           "type": ["string", "null"],
schema_composition_service_app     |                           "enum": ["TEXT","NUMBER","BOOLEAN","DATE","DATETIME","SINGLESELECT","MULTISELECT", null]
schema_composition_service_app     |                         },
schema_composition_service_app     | 
schema_composition_service_app     |                         "element_type": {
schema_composition_service_app     |                           "type": "string",
schema_composition_service_app     |                           "enum": ["TEXT","TEXTAREA","DATE","DATETIME","SELECT","MULTISELECT","ACTION"]
schema_composition_service_app     |                         },
schema_composition_service_app     | 
schema_composition_service_app     |                         "validation": { "type": ["object", "null"] },
schema_composition_service_app     |                         "ui_config": { "type": ["object", "null"] }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     },
schema_composition_service_app     | 
schema_composition_service_app     |                     "options": {
schema_composition_service_app     |                       "type": ["array", "null"],
schema_composition_service_app     |                       "items": {
schema_composition_service_app     |                         "type": "object",
schema_composition_service_app     |                         "additionalProperties": false,
schema_composition_service_app     |                         "required": ["option_key", "option_label", "option_order"],
schema_composition_service_app     |                         "properties": {
schema_composition_service_app     |                           "option_key": { "type": "string", "minLength": 1, "maxLength": 200 },
schema_composition_service_app     |                           "option_label": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                           "option_order": { "type": "integer", "minimum": 0 }
schema_composition_service_app     |                         }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     }
schema_composition_service_app     |                   }
schema_composition_service_app     |                 }$$::json,
schema_composition_service_app     |                 field_config
schema_composition_service_app     |             )
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe: forces panel_id to belong to same tenant_id.
schema_composition_service_app     |     -- Requires a UNIQUE/PK on schema_composition.component_panel(tenant_id, id) or equivalent.
schema_composition_service_app     |     CONSTRAINT fk_component_panel_field_panel_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.component_panel (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_component_panel_field_field_def_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, field_def_id)
schema_composition_service_app     |         REFERENCES schema_composition.field_def (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Common access patterns:
schema_composition_service_app     | --   - list all fields for a panel ordered by field_order
schema_composition_service_app     | --   - join to field_def to render the panel
schema_composition_service_app     | --   - tenant-scoped maintenance queries
schema_composition_service_app     | --   - diff/reset workflows (hash comparisons)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast joins to field_def (when rendering / reset provenance).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_panel_field_field_def
schema_composition_service_app     |     ON schema_composition.component_panel_field (tenant_id, field_def_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: useful for recency queries and debugging.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_panel_field_tenant_panel_updated_at
schema_composition_service_app     |     ON schema_composition.component_panel_field (tenant_id, panel_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: accelerate "is overridden" checks via hash comparisons.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_component_panel_field_hashes
schema_composition_service_app     |     ON schema_composition.component_panel_field (tenant_id, field_config_hash, source_field_def_hash);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.component_panel_field IS
schema_composition_service_app     | 'Places a reusable field_def onto a specific component panel. Controls per-panel ordering and supports per-placement UI configuration overrides. Stores an imprinted, editable field_config snapshot (field_def + options) with schema enforcement and hashes for diff/reset workflows.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.panel_id IS
schema_composition_service_app     | 'Owning component panel ID. The panel that this field placement belongs to.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.field_def_id IS
schema_composition_service_app     | 'Source catalog field definition ID (field_def). Used for provenance and reset/re-imprint. The effective field definition for this placement lives in field_config.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.field_order IS
schema_composition_service_app     | 'Default display/tab order within the panel. Null means unspecified; otherwise non-negative and unique within (tenant_id, panel_id) when present.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.ui_config IS
schema_composition_service_app     | 'JSONB UI configuration overrides applied on top of the field_config.ui_config for this specific panel placement (layout/display hints).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.field_config IS
schema_composition_service_app     | 'Imprinted JSONB snapshot of the effective field definition for this placement, including option definitions for select/multiselect. Editable without mutating the source field_def. Enforced by jsonb_matches_schema.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.field_config_hash IS
schema_composition_service_app     | 'Hash (typically sha256 hex) of the current field_config JSONB. Used to detect edits and support diff workflows efficiently.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.source_field_def_hash IS
schema_composition_service_app     | 'Hash (typically sha256 hex) of the canonical source snapshot from field_def + field_def_option at the time field_config was last imprinted. Used to detect catalog drift since imprint.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.last_imprinted_at IS
schema_composition_service_app     | 'Timestamp of the last imprint operation that copied the catalog source definition into field_config.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.component_panel_field.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines an actual form definition for a tenant.
schema_composition_service_app     | --
schema_composition_service_app     | --   A form is not a reusable catalog component. It is the concrete form
schema_composition_service_app     | --   definition that will be used for submissions. Forms can embed reusable
schema_composition_service_app     | --   catalog components and can also include direct form fields, but this table
schema_composition_service_app     | --   is the root identity and lifecycle container for the form definition.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Business identity vs row identity:
schema_composition_service_app     | --       * id is the immutable row identifier (UUID PK).
schema_composition_service_app     | --       * form_business_key + form_version provides a stable versioned identity
schema_composition_service_app     | --         for the conceptual form across publish cycles.
schema_composition_service_app     | --   - Human-facing metadata:
schema_composition_service_app     | --       * name and description support builder UI listing and management.
schema_composition_service_app     | --   - Lifecycle:
schema_composition_service_app     | --       * is_published controls availability for use in submissions.
schema_composition_service_app     | --       * is_archived indicates the form is no longer actively offered but is
schema_composition_service_app     | --         retained for history/back-compat.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes all data to a tenant boundary.
schema_composition_service_app     | --   - form_business_key + form_version is unique per tenant.
schema_composition_service_app     | --   - Publishing / archiving timestamps are consistent with their flags:
schema_composition_service_app     | --       * is_published = true  => published_at is not null
schema_composition_service_app     | --       * is_published = false => published_at is null
schema_composition_service_app     | --       * is_archived = true   => archived_at is not null
schema_composition_service_app     | --       * is_archived = false  => archived_at is null
schema_composition_service_app     | --   - updated_at is maintained by application code or a DB trigger (not included here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant boundary. This table is always tenant-scoped.
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Versioned business identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Stable business key used to identify a form across versions within a tenant.
schema_composition_service_app     |     -- Typically used for import/export and version lineage.
schema_composition_service_app     |     form_business_key VARCHAR(400) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Monotonic version number for a given (tenant_id, form_business_key).
schema_composition_service_app     |     -- Typically starts at 1 and increments for new versions.
schema_composition_service_app     |     form_version INTEGER NOT NULL DEFAULT 1,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Human-facing metadata (builder/admin UI)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     name VARCHAR(255) NOT NULL,
schema_composition_service_app     |     description VARCHAR(500),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Lifecycle / availability
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Published means "available to be used for new submissions".
schema_composition_service_app     |     is_published BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     published_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archived means "retained for history/back-compat but not actively offered".
schema_composition_service_app     |     -- Default should be FALSE for newly created forms.
schema_composition_service_app     |     is_archived BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     |     archived_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     source_type schema_composition.artifact_source_type,
schema_composition_service_app     |     source_package_key VARCHAR(400),
schema_composition_service_app     |     source_artifact_key VARCHAR(400),
schema_composition_service_app     |     source_artifact_version VARCHAR(100),
schema_composition_service_app     |     source_checksum VARCHAR(64),
schema_composition_service_app     |     installed_at TIMESTAMPTZ,
schema_composition_service_app     |     installed_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Supports tenant-safe composite foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_id_tenant 
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Ensure version is sensible.
schema_composition_service_app     |     CONSTRAINT ck_form_version_positive
schema_composition_service_app     |         CHECK (form_version >= 1),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent blank/whitespace identifiers.
schema_composition_service_app     |     CONSTRAINT ck_form_business_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(form_business_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_form_name_nonblank
schema_composition_service_app     |         CHECK (length(btrim(name)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Versioned identity uniqueness within tenant.
schema_composition_service_app     |     CONSTRAINT uq_form_tenant_business_key_version
schema_composition_service_app     |         UNIQUE (tenant_id, form_business_key, form_version),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Publishing timestamp must align with published flag.
schema_composition_service_app     |     CONSTRAINT ck_form_published_at_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_published = TRUE  AND published_at IS NOT NULL)
schema_composition_service_app     |          OR (is_published = FALSE AND published_at IS NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archiving timestamp must align with archived flag.
schema_composition_service_app     |     CONSTRAINT ck_form_archived_at_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_archived = TRUE  AND archived_at IS NOT NULL)
schema_composition_service_app     |          OR (is_archived = FALSE AND archived_at IS NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_form_source_checksum_format
schema_composition_service_app     |         CHECK (source_checksum IS NULL OR source_checksum ~ '^[0-9a-f]{64}$')
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Common access patterns:
schema_composition_service_app     | --   - list forms by tenant (optionally only published / not archived)
schema_composition_service_app     | --   - resolve by (business_key, version) or get latest version
schema_composition_service_app     | --   - search/browse by name within tenant
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Uniqueness: one name per tenant (builder UI friendly).
schema_composition_service_app     | CREATE UNIQUE INDEX IF NOT EXISTS ux_form_tenant_name
schema_composition_service_app     |     ON schema_composition.form (tenant_id, name);
schema_composition_service_app     | 
schema_composition_service_app     | -- Catalog listing filters (published / archived).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_tenant_catalog_state
schema_composition_service_app     |     ON schema_composition.form (tenant_id, is_published, is_archived);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: case-insensitive search by name.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_tenant_name_lower
schema_composition_service_app     |     ON schema_composition.form (tenant_id, lower(name));
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_tenant_source_type
schema_composition_service_app     |     ON schema_composition.form (tenant_id, source_type);
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_tenant_source_keys
schema_composition_service_app     |     ON schema_composition.form (tenant_id, source_package_key, source_artifact_key, source_artifact_version);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form IS
schema_composition_service_app     | 'Actual tenant-scoped form definition (non-reusable). Uses a versioned business identity (form_business_key + form_version) and lifecycle flags to control availability for new submissions while retaining older versions for history/back-compat.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All form rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.form_business_key IS
schema_composition_service_app     | 'Stable business identifier for the conceptual form across versions within a tenant. Used for version lineage and import/export.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.form_version IS
schema_composition_service_app     | 'Version number for a given (tenant_id, form_business_key). Starts at 1 and increments for new versions.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.name IS
schema_composition_service_app     | 'Human-readable name shown in builder/admin UI. Unique within a tenant.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.description IS
schema_composition_service_app     | 'Optional human-readable description for builder/admin UI.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.is_published IS
schema_composition_service_app     | 'When true, the form is available for selection and new submissions. When false, it is hidden/unavailable for new use.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.published_at IS
schema_composition_service_app     | 'Timestamp when the form was published. Must be non-null only when is_published is true.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.is_archived IS
schema_composition_service_app     | 'When true, the form is archived (retained for history/back-compat but not actively offered).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.archived_at IS
schema_composition_service_app     | 'Timestamp when the form was archived. Must be non-null only when is_archived is true.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.source_type IS
schema_composition_service_app     |     'Provenance classification of the artifact installation. Allowed values: MARKETPLACE, PROVIDER, TENANT, SYSTEM.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.source_package_key IS
schema_composition_service_app     |     'Key identifying the package from which this form artifact originated (e.g., marketplace or provider package).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.source_artifact_key IS
schema_composition_service_app     |     'Key identifying the specific artifact within the source package.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.source_artifact_version IS
schema_composition_service_app     |     'Version string of the source artifact from which this form was installed.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.source_checksum IS
schema_composition_service_app     |     'SHA-256 checksum (64 hex characters) of the source artifact at install time. Used to detect source changes and upgrade eligibility.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.installed_at IS
schema_composition_service_app     |     'Timestamp when this form artifact was installed for the tenant.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.installed_by IS
schema_composition_service_app     |     'Actor (username/service) that installed this form artifact.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_panel
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines a panel within an actual form definition.
schema_composition_service_app     | --
schema_composition_service_app     | --   form_panel is intentionally very similar to component_panel, but it exists
schema_composition_service_app     | --   in the "form composition" domain (non-reusable instance definition) and it
schema_composition_service_app     | --   is the primary location where embedded components can be customized without
schema_composition_service_app     | --   modifying the underlying catalog tables:
schema_composition_service_app     | --     - schema_composition.component
schema_composition_service_app     | --     - schema_composition.component_panel
schema_composition_service_app     | --     - schema_composition.component_panel_field
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Stable identity:
schema_composition_service_app     | --       panel_key is a stable, form-scoped identifier used by builders and APIs.
schema_composition_service_app     | --       panel_label is the user-facing label shown in UI.
schema_composition_service_app     | --   - Layout configuration:
schema_composition_service_app     | --       ui_config contains layout and rendering hints for the panel container.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - form_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - panel_key is unique per (tenant_id, form_id).
schema_composition_service_app     | --   - updated_at is maintained by application code or a DB trigger (not included here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_panel (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary and owning form
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The form this panel belongs to.
schema_composition_service_app     |     form_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable key for referencing this panel within the form.
schema_composition_service_app     |     -- Intended for APIs, builders, and deterministic lookup.
schema_composition_service_app     |     panel_key VARCHAR(200) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Human-readable label shown in UI.
schema_composition_service_app     |     panel_label VARCHAR(200),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSON UI configuration (layout/styling/container hints).
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   { "layout": "two_column", "css": {"gap": "12px"}, "collapsible": true }
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Supports tenant-safe composite foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_panel_tenant_id
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: prevent empty/whitespace-only keys.
schema_composition_service_app     |     CONSTRAINT ck_form_panel_key_nonblank
schema_composition_service_app     |         CHECK (length(btrim(panel_key)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: prevent empty/whitespace-only label if provided.
schema_composition_service_app     |     CONSTRAINT ck_form_panel_label_nonblank
schema_composition_service_app     |         CHECK (panel_label IS NULL OR length(btrim(panel_label)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Stable identity within a form.
schema_composition_service_app     |     CONSTRAINT uq_form_panel_tenant_form_panel_key
schema_composition_service_app     |         UNIQUE (tenant_id, form_id, panel_key),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK: forces form_id to belong to same tenant_id.
schema_composition_service_app     |     -- Requires a UNIQUE/PK on schema_composition.form(tenant_id, id) or equivalent.
schema_composition_service_app     |     CONSTRAINT fk_form_panel_form_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, form_id)
schema_composition_service_app     |         REFERENCES schema_composition.form (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Common access patterns:
schema_composition_service_app     | --   - list panels for a form
schema_composition_service_app     | --   - resolve a panel by (tenant_id, form_id, panel_key)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Load all panels for a form efficiently.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_tenant_form
schema_composition_service_app     |     ON schema_composition.form_panel (tenant_id, form_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: useful for recency queries and debugging.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_tenant_form_updated_at
schema_composition_service_app     |     ON schema_composition.form_panel (tenant_id, form_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_panel IS
schema_composition_service_app     | 'Panel within an actual form definition. Similar to component_panel but used for form composition.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All form panels are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.form_id IS
schema_composition_service_app     | 'Owning form ID. The form that this panel belongs to.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.panel_key IS
schema_composition_service_app     | 'Stable identifier for this panel within (tenant_id, form_id). Used by builders/APIs for deterministic lookup.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.panel_label IS
schema_composition_service_app     | 'Human-readable label shown in UI. Optional.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.ui_config IS
schema_composition_service_app     | 'JSONB UI configuration for layout, styling, and container-level rendering hints for the form panel.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_panel_field
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Defines a non-reusable field realization placed directly onto a form panel.
schema_composition_service_app     | --
schema_composition_service_app     | --   This table is intentionally very similar to schema_composition.component_panel_field,
schema_composition_service_app     | --   but it lives in the form domain (form definitions are not reusable like catalog
schema_composition_service_app     | --   components). A form_panel_field represents a concrete field instance as used
schema_composition_service_app     | --   by a specific form, with its own imprinted and editable field_config.
schema_composition_service_app     | --
schema_composition_service_app     | --   Key idea:
schema_composition_service_app     | --     - field_def_id is a provenance and reset source (optional conceptually),
schema_composition_service_app     | --       but the effective definition used by the form lives in field_config.
schema_composition_service_app     | --     - Editing the field inside a form updates field_config and does not mutate
schema_composition_service_app     | --       the catalog field_def.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Composition (form_panel + field_def):
schema_composition_service_app     | --       A form panel contains zero or more fields. Each row represents one field
schema_composition_service_app     | --       instance placed on that panel, sourced from a catalog field_def.
schema_composition_service_app     | --   - Ordering:
schema_composition_service_app     | --       field_order controls default tab/display ordering within the form panel.
schema_composition_service_app     | --   - UI configuration overrides:
schema_composition_service_app     | --       field_config.field.ui_config is the imprinted base.
schema_composition_service_app     | --       form_panel_field.ui_config is an override/augmentation applied in the
schema_composition_service_app     | --       context of this specific placement.
schema_composition_service_app     | --   - Imprinting (field_config):
schema_composition_service_app     | --       field_config is a JSONB snapshot that can fully represent the effective
schema_composition_service_app     | --       field_def and its options at the time the field was placed on the form.
schema_composition_service_app     | --       Edits modify field_config, not field_def.
schema_composition_service_app     | --   - Hashing:
schema_composition_service_app     | --       * field_config_hash: hash of the current field_config JSONB (detect edits/diff).
schema_composition_service_app     | --       * source_field_def_hash: hash of the canonical source snapshot from field_def
schema_composition_service_app     | --         (field_def + field_def_option) at imprint time (detect catalog drift).
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - panel_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - field_def_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - A given (tenant_id, panel_id, field_def_id) is unique to prevent accidental
schema_composition_service_app     | --     duplicate placement of the same field_def on the same form panel.
schema_composition_service_app     | --   - field_order, when provided, must be >= 0.
schema_composition_service_app     | --   - field_config must conform to the JSON schema enforced by jsonb_matches_schema.
schema_composition_service_app     | --   - Hash columns are typically maintained by application logic or triggers.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_panel_field (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary and owning form panel
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The form panel this field belongs to.
schema_composition_service_app     |     panel_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The catalog field definition used as the source for this field placement.
schema_composition_service_app     |     -- This is provenance and reset source. The effective definition used by the
schema_composition_service_app     |     -- form lives in field_config (imprinted snapshot).
schema_composition_service_app     |     field_def_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Default display/tab order within the form panel.
schema_composition_service_app     |     -- Null means "unspecified" (UI/service may apply a default ordering strategy).
schema_composition_service_app     |     field_order INTEGER,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional UI overrides applied for this specific placement on the form panel.
schema_composition_service_app     |     -- This is layered on top of field_config.field.ui_config.
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Imprinted field definition snapshot
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- JSONB snapshot representing the effective field definition and options for this
schema_composition_service_app     |     -- placement. This is the editable copy that can diverge from the catalog field_def.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- The schema is enforced via public.jsonb_matches_schema(field_config, <schema>).
schema_composition_service_app     |     field_config JSONB NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Hash of the current field_config JSONB (typically sha256 hex, 64 chars).
schema_composition_service_app     |     -- Used to detect edits and support fast diff checks without deep JSON comparison.
schema_composition_service_app     |     field_config_hash VARCHAR(64),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Hash of the canonical source snapshot from field_def + field_def_option that was
schema_composition_service_app     |     -- used to imprint field_config initially (typically sha256 hex, 64 chars).
schema_composition_service_app     |     -- Used to detect when the catalog source changed since imprint (reset candidate).
schema_composition_service_app     |     source_field_def_hash VARCHAR(64),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Timestamp when field_config was last imprinted from the catalog source.
schema_composition_service_app     |     last_imprinted_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Supports tenant-safe composite foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_panel_field_tenant_id
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: ordering, when provided, must be non-negative.
schema_composition_service_app     |     CONSTRAINT ck_form_panel_field_order_non_negative
schema_composition_service_app     |         CHECK (field_order IS NULL OR field_order >= 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Prevent duplicate placement of the same field_def on the same form panel.
schema_composition_service_app     |     CONSTRAINT uq_form_panel_field_panel_field_def
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, field_def_id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional: enforce a single field_order value per panel when field_order is used.
schema_composition_service_app     |     -- This helps prevent "two fields share order 10" ambiguity.
schema_composition_service_app     |     -- (Allows multiple NULLs.)
schema_composition_service_app     |     CONSTRAINT uq_form_panel_field_panel_order
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, field_order),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce hash formatting when provided (sha256 hex).
schema_composition_service_app     |     CONSTRAINT ck_form_panel_field_field_config_hash_format
schema_composition_service_app     |         CHECK (field_config_hash IS NULL OR field_config_hash ~ '^[0-9a-f]{64}$'),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_form_panel_field_source_field_def_hash_format
schema_composition_service_app     |         CHECK (source_field_def_hash IS NULL OR source_field_def_hash ~ '^[0-9a-f]{64}$'),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce field_config JSON schema.
schema_composition_service_app     |     -- NOTE: This assumes public.jsonb_matches_schema(instance_jsonb, schema_jsonb) exists.
schema_composition_service_app     |     CONSTRAINT ck_form_panel_field_field_config_schema
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             public.jsonb_matches_schema(
schema_composition_service_app     |                 $${
schema_composition_service_app     |                   "$schema": "http://json-schema.org/draft-07/schema#",
schema_composition_service_app     |                   "title": "DynoCRM Form Panel Field Config",
schema_composition_service_app     |                   "type": "object",
schema_composition_service_app     |                   "additionalProperties": false,
schema_composition_service_app     |                   "required": ["schema_version", "field"],
schema_composition_service_app     |                   "properties": {
schema_composition_service_app     |                     "schema_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     | 
schema_composition_service_app     |                     "field": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": false,
schema_composition_service_app     |                       "required": ["field_key", "label", "element_type"],
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "field_def_business_key": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                         "field_def_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "name": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "description": { "type": ["string", "null"], "maxLength": 1000 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "field_key": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "label": { "type": "string", "minLength": 1, "maxLength": 255 },
schema_composition_service_app     | 
schema_composition_service_app     |                         "category_id": { "type": ["string", "null"], "pattern": "^[0-9a-fA-F-]{36}$" },
schema_composition_service_app     | 
schema_composition_service_app     |                         "data_type": {
schema_composition_service_app     |                           "type": ["string", "null"],
schema_composition_service_app     |                           "enum": ["TEXT","NUMBER","BOOLEAN","DATE","DATETIME","SINGLESELECT","MULTISELECT", null]
schema_composition_service_app     |                         },
schema_composition_service_app     | 
schema_composition_service_app     |                         "element_type": {
schema_composition_service_app     |                           "type": "string",
schema_composition_service_app     |                           "enum": ["TEXT","TEXTAREA","DATE","DATETIME","SELECT","MULTISELECT","ACTION"]
schema_composition_service_app     |                         },
schema_composition_service_app     | 
schema_composition_service_app     |                         "validation": { "type": ["object", "null"] },
schema_composition_service_app     |                         "ui_config": { "type": ["object", "null"] }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     },
schema_composition_service_app     | 
schema_composition_service_app     |                     "options": {
schema_composition_service_app     |                       "type": ["array", "null"],
schema_composition_service_app     |                       "items": {
schema_composition_service_app     |                         "type": "object",
schema_composition_service_app     |                         "additionalProperties": false,
schema_composition_service_app     |                         "required": ["option_key", "option_label", "option_order"],
schema_composition_service_app     |                         "properties": {
schema_composition_service_app     |                           "option_key": { "type": "string", "minLength": 1, "maxLength": 200 },
schema_composition_service_app     |                           "option_label": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                           "option_order": { "type": "integer", "minimum": 0 }
schema_composition_service_app     |                         }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     }
schema_composition_service_app     |                   }
schema_composition_service_app     |                 }$$::json,
schema_composition_service_app     |                 field_config
schema_composition_service_app     |             )
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe: forces panel_id to belong to same tenant_id.
schema_composition_service_app     |     -- Requires a UNIQUE/PK on schema_composition.form_panel(tenant_id, id) or equivalent.
schema_composition_service_app     |     CONSTRAINT fk_form_panel_field_panel_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_panel_field_field_def_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, field_def_id)
schema_composition_service_app     |         REFERENCES schema_composition.field_def (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Common access patterns:
schema_composition_service_app     | --   - list all fields for a form panel ordered by field_order
schema_composition_service_app     | --   - join to field_def for reset/provenance workflows
schema_composition_service_app     | --   - tenant-scoped maintenance queries
schema_composition_service_app     | --   - diff/reset workflows (hash comparisons)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast joins to field_def (reset/provenance).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_field_field_def
schema_composition_service_app     |     ON schema_composition.form_panel_field (tenant_id, field_def_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: useful for recency queries and debugging.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_field_tenant_panel_updated_at
schema_composition_service_app     |     ON schema_composition.form_panel_field (tenant_id, panel_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- Optional: accelerate "is overridden" checks via hash comparisons.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_field_hashes
schema_composition_service_app     |     ON schema_composition.form_panel_field (tenant_id, field_config_hash, source_field_def_hash);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_panel_field IS
schema_composition_service_app     | 'Non-reusable field realization placed directly on a form panel. Stores an imprinted, editable field_config snapshot (field_def + options) with schema enforcement and hashes for diff/reset workflows.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.panel_id IS
schema_composition_service_app     | 'Owning form panel ID. The form panel that this field placement belongs to.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.field_def_id IS
schema_composition_service_app     | 'Source catalog field definition ID (field_def). Used for provenance and reset/re-imprint. The effective field definition for this placement lives in field_config.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.field_order IS
schema_composition_service_app     | 'Default display/tab order within the form panel. Null means unspecified; otherwise non-negative and unique within (tenant_id, panel_id) when present.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.ui_config IS
schema_composition_service_app     | 'JSONB UI configuration overrides applied on top of the field_config.field.ui_config for this specific form placement (layout/display hints).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.field_config IS
schema_composition_service_app     | 'Imprinted JSONB snapshot of the effective field definition for this form placement, including option definitions for select/multiselect. Editable without mutating the source field_def. Enforced by jsonb_matches_schema.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.field_config_hash IS
schema_composition_service_app     | 'Hash (typically sha256 hex) of the current field_config JSONB. Used to detect edits and support diff workflows efficiently.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.source_field_def_hash IS
schema_composition_service_app     | 'Hash (typically sha256 hex) of the canonical source snapshot from field_def + field_def_option at the time field_config was last imprinted. Used to detect catalog drift since imprint.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.last_imprinted_at IS
schema_composition_service_app     | 'Timestamp of the last imprint operation that copied the catalog source definition into field_config.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_field.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_panel_component
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Places a reusable component onto a specific form panel.  Provides
schema_composition_service_app     | --   per-panel ordering and per-placement UI overrides for the component.
schema_composition_service_app     | --   Each placement references a specific versioned component via
schema_composition_service_app     | --   component_id.  When a new version of a component is published, a
schema_composition_service_app     | --   form can choose to upgrade by updating the component_id.
schema_composition_service_app     | --
schema_composition_service_app     | --   The customization mechanism is nested_overrides, which applies PATCH-style
schema_composition_service_app     | --   overrides to nested panel_config and field_config inside embedded components.
schema_composition_service_app     | --   This allows a form to tailor a reused component (labels, validation, options,
schema_composition_service_app     | --   ui hints, panel_actions, etc.) while keeping the catalog component intact.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Each row represents one instance of a component placed directly
schema_composition_service_app     | --     onto a form panel.
schema_composition_service_app     | --   - component_order controls ordering within the panel.  NULL means
schema_composition_service_app     | --     unspecified; otherwise must be non-negative and unique per
schema_composition_service_app     | --     (tenant_id, panel_id).
schema_composition_service_app     | --   - ui_config overrides the base configuration from the component.
schema_composition_service_app     | --   - Embedded component customization:
schema_composition_service_app     | --       nested_overrides contains selector-addressed patches that apply to:
schema_composition_service_app     | --         * field_config of component_panel_field nodes
schema_composition_service_app     | --         * panel_config of component_panel nodes
schema_composition_service_app     | --       Overrides are always PATCH semantics (no REPLACE mode).
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - panel_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - component_id must belong to the same tenant_id (tenant-safe FK).
schema_composition_service_app     | --   - A given (tenant_id, panel_id, component_id) should be unique to
schema_composition_service_app     | --     prevent accidental duplicate placement of the same component on
schema_composition_service_app     | --     the same panel.
schema_composition_service_app     | --   - nested_overrides must conform to the Nested Overrides JSON schema.
schema_composition_service_app     | --   - updated_at is maintained by application code or a trigger.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_panel_component (
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     |     panel_id UUID NOT NULL,
schema_composition_service_app     |     component_id UUID NOT NULL,
schema_composition_service_app     |     component_order INTEGER,
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Nested override patches for embedded component customization
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- JSON document containing selector-addressed PATCH overrides that apply to
schema_composition_service_app     |     -- nested catalog objects inside components embedded within this form panel.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Why this exists:
schema_composition_service_app     |     --   Components and their panels/fields are catalog items reused across forms.
schema_composition_service_app     |     --   A specific form embedding a component often needs small overrides without
schema_composition_service_app     |     --   forking or mutating the catalog definitions.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- How it works:
schema_composition_service_app     |     --   - The form builder materializes the embedded component tree.
schema_composition_service_app     |     --   - For each override entry, selector resolves a target node in that tree.
schema_composition_service_app     |     --   - The provided field_config and/or panel_config objects are merged (PATCH)
schema_composition_service_app     |     --     into the target node's effective config.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Selector addressing:
schema_composition_service_app     |     --   - Dot-separated path.
schema_composition_service_app     |     --   - If selector starts with '.', it is relative to the current embedded component
schema_composition_service_app     |     --     context within this form_panel.
schema_composition_service_app     |     --   - If selector does not start with '.', it is absolute from the form root.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Patch semantics:
schema_composition_service_app     |     --   - Always PATCH (object merge).
schema_composition_service_app     |     --   - Arrays (such as options lists) are treated as replace-the-array unless a
schema_composition_service_app     |     --     more advanced id-based merge protocol is introduced later.
schema_composition_service_app     |     nested_overrides JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ux_form_panel_component_tenant_id
schema_composition_service_app     |     UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     CONSTRAINT ck_form_panel_component_order_non_negative
schema_composition_service_app     |         CHECK (component_order IS NULL OR component_order >= 0),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT uq_form_panel_component_panel_component
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, component_id),
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT uq_form_panel_component_panel_order
schema_composition_service_app     |         UNIQUE (tenant_id, panel_id, component_order),    
schema_composition_service_app     |     
schema_composition_service_app     |     -- Enforce nested_overrides JSON schema when present.
schema_composition_service_app     |     -- NOTE: Assumes public.jsonb_matches_schema(instance_jsonb, schema_jsonb) exists.
schema_composition_service_app     |     CONSTRAINT ck_form_panel_nested_overrides_schema
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             nested_overrides IS NULL
schema_composition_service_app     |             OR public.jsonb_matches_schema(
schema_composition_service_app     |                 $${
schema_composition_service_app     |                   "$schema": "http://json-schema.org/draft-07/schema#",
schema_composition_service_app     |                   "title": "DynoCRM Nested Overrides",
schema_composition_service_app     |                   "type": "object",
schema_composition_service_app     |                   "additionalProperties": false,
schema_composition_service_app     |                   "required": ["schema_version", "overrides"],
schema_composition_service_app     |                   "properties": {
schema_composition_service_app     |                     "schema_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     |                     "overrides": {
schema_composition_service_app     |                       "type": "array",
schema_composition_service_app     |                       "items": { "$ref": "#/definitions/override_entry" }
schema_composition_service_app     |                     }
schema_composition_service_app     |                   },
schema_composition_service_app     |                   "definitions": {
schema_composition_service_app     |                     "override_entry": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": false,
schema_composition_service_app     |                       "required": ["selector"],
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "selector": {
schema_composition_service_app     |                           "type": "string",
schema_composition_service_app     |                           "minLength": 2,
schema_composition_service_app     |                           "maxLength": 800,
schema_composition_service_app     |                           "description": "Dot-separated path. If it starts with '.', it is relative to the current embedded component context; otherwise absolute from the form root.",
schema_composition_service_app     |                           "pattern": "^(\\.|[A-Za-z0-9_\\-]+)(\\.[A-Za-z0-9_\\-]+)+$"
schema_composition_service_app     |                         },
schema_composition_service_app     |                         "field_config": { "$ref": "#/definitions/field_config_patch" },
schema_composition_service_app     |                         "panel_config": { "$ref": "#/definitions/panel_config_patch" }
schema_composition_service_app     |                       },
schema_composition_service_app     |                       "anyOf": [
schema_composition_service_app     |                         { "required": ["field_config"] },
schema_composition_service_app     |                         { "required": ["panel_config"] }
schema_composition_service_app     |                       ]
schema_composition_service_app     |                     },
schema_composition_service_app     |                     "field_config_patch": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": false,
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "field": { "$ref": "#/definitions/field_patch" },
schema_composition_service_app     |                         "options": { "$ref": "#/definitions/options_patch" }
schema_composition_service_app     |                       },
schema_composition_service_app     |                       "minProperties": 1,
schema_composition_service_app     |                       "description": "PATCH object merged into the target field_config."
schema_composition_service_app     |                     },
schema_composition_service_app     |                     "field_patch": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": true,
schema_composition_service_app     |                       "description": "Partial patch of the field definition portion. Permissive for forward compatibility.",
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "field_def_business_key": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                         "field_def_version": { "type": "integer", "minimum": 1 },
schema_composition_service_app     |                         "name": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "description": { "type": ["string", "null"], "maxLength": 1000 },
schema_composition_service_app     |                         "field_key": { "type": "string", "minLength": 1, "maxLength": 100 },
schema_composition_service_app     |                         "label": { "type": "string", "minLength": 1, "maxLength": 255 },
schema_composition_service_app     |                         "category_id": { "type": ["string", "null"], "pattern": "^[0-9a-fA-F-]{36}$" },
schema_composition_service_app     |                         "data_type": {
schema_composition_service_app     |                           "type": ["string", "null"],
schema_composition_service_app     |                           "enum": ["TEXT","NUMBER","BOOLEAN","DATE","DATETIME","SINGLESELECT","MULTISELECT", null]
schema_composition_service_app     |                         },
schema_composition_service_app     |                         "element_type": {
schema_composition_service_app     |                           "type": "string",
schema_composition_service_app     |                           "enum": ["TEXT","TEXTAREA","DATE","DATETIME","SELECT","MULTISELECT","ACTION"]
schema_composition_service_app     |                         },
schema_composition_service_app     |                         "validation": { "type": ["object", "null"] },
schema_composition_service_app     |                         "ui_config": { "type": ["object", "null"] }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     "options_patch": {
schema_composition_service_app     |                       "type": "array",
schema_composition_service_app     |                       "description": "Full replacement of the option list within the field_config (still PATCH semantics at the override entry level).",
schema_composition_service_app     |                       "items": {
schema_composition_service_app     |                         "type": "object",
schema_composition_service_app     |                         "additionalProperties": false,
schema_composition_service_app     |                         "required": ["option_key", "option_label", "option_order"],
schema_composition_service_app     |                         "properties": {
schema_composition_service_app     |                           "option_key": { "type": "string", "minLength": 1, "maxLength": 200 },
schema_composition_service_app     |                           "option_label": { "type": "string", "minLength": 1, "maxLength": 400 },
schema_composition_service_app     |                           "option_order": { "type": "integer", "minimum": 0 }
schema_composition_service_app     |                         }
schema_composition_service_app     |                       }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     "panel_config_patch": {
schema_composition_service_app     |                       "type": "object",
schema_composition_service_app     |                       "additionalProperties": false,
schema_composition_service_app     |                       "properties": {
schema_composition_service_app     |                         "panel_label": { "type": ["string", "null"], "maxLength": 200 },
schema_composition_service_app     |                         "ui_config": { "type": ["object", "null"] },
schema_composition_service_app     |                         "panel_actions": { "type": ["object", "null"] }
schema_composition_service_app     |                       },
schema_composition_service_app     |                       "minProperties": 1,
schema_composition_service_app     |                       "description": "PATCH object merged into the target panel config."
schema_composition_service_app     |                     }
schema_composition_service_app     |                   }
schema_composition_service_app     |                 }$$::json,
schema_composition_service_app     |                 nested_overrides
schema_composition_service_app     |             )
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_panel
schema_composition_service_app     |         FOREIGN KEY (panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel (id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_panel_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_component
schema_composition_service_app     |         FOREIGN KEY (component_id)
schema_composition_service_app     |         REFERENCES schema_composition.component (id)
schema_composition_service_app     |         ON DELETE RESTRICT,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_component_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, component_id)
schema_composition_service_app     |         REFERENCES schema_composition.component (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes for schema_composition.form_panel_component
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast tenant scoping
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_component_tenant_id
schema_composition_service_app     |     ON schema_composition.form_panel_component (tenant_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Load all components for a panel efficiently (and sort by component_order)
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_component_panel_order
schema_composition_service_app     |     ON schema_composition.form_panel_component (tenant_id, panel_id, component_order);
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast joins to component (when rendering)
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_component_component
schema_composition_service_app     |     ON schema_composition.form_panel_component (tenant_id, component_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Column comments for schema_composition.form_panel_component
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_panel_component IS
schema_composition_service_app     | 'Places a reusable component onto a specific form panel. Controls per-panel ordering and supports per-placement UI configuration overrides. The component_id references a specific version of a component. Tenant-scoped and panel-scoped. Supports nested_overrides to PATCH embedded catalog components, panels, and fields without mutating catalog items.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.panel_id IS
schema_composition_service_app     | 'Owning form panel ID. The panel that this component placement belongs to.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.component_id IS
schema_composition_service_app     | 'Reusable component ID (component). The component definition placed on this form panel. Versioned by the component record.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.component_order IS
schema_composition_service_app     | 'Default display/tab order within the panel for components. Null means unspecified; otherwise non-negative and unique within (tenant_id, panel_id) when present.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.ui_config IS
schema_composition_service_app     | 'JSONB UI configuration overrides applied on top of component.ui_config for this specific panel placement (layout, display hints, conditional UI metadata, etc.).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_submission
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Represents a tenant-scoped "submission envelope" for a specific form.
schema_composition_service_app     | --
schema_composition_service_app     | --   A submission is intentionally UPDATABLE:
schema_composition_service_app     | --     - Users/automations can save drafts (update the submission and its values)
schema_composition_service_app     | --     - Users can submit, and later re-submit (update again + bump submission_version)
schema_composition_service_app     | --
schema_composition_service_app     | --   The actual field answers live in schema_composition.form_submission_value
schema_composition_service_app     | --   (one row per field instance per submission).
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Draft vs submitted:
schema_composition_service_app     | --       * is_submitted = FALSE  => draft (can be saved/updated without being "submitted")
schema_composition_service_app     | --       * is_submitted = TRUE   => submitted at least once
schema_composition_service_app     | --
schema_composition_service_app     | --   - submission_version:
schema_composition_service_app     | --       Tracks how many times this submission has been submitted.
schema_composition_service_app     | --       * Draft: submission_version = 0
schema_composition_service_app     | --       * First submit: submission_version = 1
schema_composition_service_app     | --       * Re-submit: submission_version increments (2, 3, ...)
schema_composition_service_app     | --
schema_composition_service_app     | --       This is an intentional "counter" style field.
schema_composition_service_app     | --       The application is expected to increment it when a submit action occurs.
schema_composition_service_app     | --
schema_composition_service_app     | -- TENANT SAFETY
schema_composition_service_app     | --   - tenant_id is required.
schema_composition_service_app     | --   - All parent references are tenant-safe composite foreign keys.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - A submission always belongs to exactly one tenant and one form.
schema_composition_service_app     | --   - submitted_at and submission_version must align with is_submitted.
schema_composition_service_app     | --   - archived_at must align with is_archived.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_submission (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Immutable technical row identifier for this submission envelope.
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant that owns this submission (hard isolation boundary).
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Composition reference
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- The form definition that this submission belongs to.
schema_composition_service_app     |     -- This is tenant-safe: the referenced form must be owned by the same tenant.
schema_composition_service_app     |     form_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Submission lifecycle
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Indicates whether the submission has been formally submitted at least once.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- TRUE  => submitted (submission_version >= 1 and submitted_at is required)
schema_composition_service_app     |     -- FALSE => draft     (submission_version = 0 and submitted_at must be NULL)
schema_composition_service_app     |     is_submitted BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Timestamp of the most recent submit action.
schema_composition_service_app     |     -- This is NULL for drafts.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- For re-submissions, this is expected to be updated to the latest submission time.
schema_composition_service_app     |     submitted_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Monotonic counter of how many times this submission has been submitted.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- 0 => draft only (never submitted)
schema_composition_service_app     |     -- 1 => submitted once
schema_composition_service_app     |     -- 2 => submitted twice (re-submitted once)
schema_composition_service_app     |     -- etc.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- This is NOT a historical record; it is an operational counter.
schema_composition_service_app     |     submission_version INTEGER NOT NULL DEFAULT 0,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archived means "no longer active" but retained for history/audit.
schema_composition_service_app     |     -- Archiving does not imply the submission cannot be updated; that policy is
schema_composition_service_app     |     -- application-defined. This schema only enforces timestamp consistency.
schema_composition_service_app     |     is_archived BOOLEAN NOT NULL DEFAULT FALSE,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Timestamp when the submission was archived (if archived).
schema_composition_service_app     |     archived_at TIMESTAMPTZ,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Row creation timestamp (envelope creation; usually when the draft starts).
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Row last-updated timestamp (should be updated by application logic or trigger).
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional actor identifier (username/service) that created the submission.
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional actor identifier (username/service) that last updated the submission.
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Canonical tenant-safe helper unique constraint.
schema_composition_service_app     |     -- Supports composite tenant-safe foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_submission_tenant_id
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Enforce reasonable bounds on the submission counter.
schema_composition_service_app     |     -- (0 for drafts; positive integers for submitted states.)
schema_composition_service_app     |     CONSTRAINT ck_form_submission_version_non_negative
schema_composition_service_app     |         CHECK (submission_version >= 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Ensure submitted_at and submission_version align with is_submitted.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Draft state (not yet submitted):
schema_composition_service_app     |     --   - is_submitted = FALSE
schema_composition_service_app     |     --   - submitted_at IS NULL
schema_composition_service_app     |     --   - submission_version = 0
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Submitted state (submitted at least once):
schema_composition_service_app     |     --   - is_submitted = TRUE
schema_composition_service_app     |     --   - submitted_at IS NOT NULL
schema_composition_service_app     |     --   - submission_version >= 1
schema_composition_service_app     |     CONSTRAINT ck_form_submission_submitted_state_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_submitted = FALSE AND submitted_at IS NULL AND submission_version = 0)
schema_composition_service_app     |             OR
schema_composition_service_app     |             (is_submitted = TRUE  AND submitted_at IS NOT NULL AND submission_version >= 1)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Archiving timestamp must align with archived flag.
schema_composition_service_app     |     CONSTRAINT ck_form_submission_archived_at_consistency
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             (is_archived = TRUE  AND archived_at IS NOT NULL)
schema_composition_service_app     |          OR (is_archived = FALSE AND archived_at IS NULL)
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK to forms.
schema_composition_service_app     |     CONSTRAINT fk_form_submission_form_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, form_id)
schema_composition_service_app     |         REFERENCES schema_composition.form (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- These support common, predictable access patterns without over-indexing:
schema_composition_service_app     | --   - list submissions for a form (tenant + form)
schema_composition_service_app     | --   - list recent submissions for a form (tenant + form + updated_at)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_tenant_form
schema_composition_service_app     |     ON schema_composition.form_submission (tenant_id, form_id);
schema_composition_service_app     | 
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_tenant_form_updated_at
schema_composition_service_app     |     ON schema_composition.form_submission (tenant_id, form_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_submission IS
schema_composition_service_app     | 'Updatable tenant-scoped submission envelope for a specific form. Stores lifecycle state (draft vs submitted), last submitted timestamp, and a submission_version counter (0 for drafts; increments per submit/re-submit). Actual field values are stored in schema_composition.form_submission_value (one row per field instance per submission).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity for the submission envelope.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. Submissions are strictly scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.form_id IS
schema_composition_service_app     | 'Identifier of the owning form definition (schema_composition.form.id). Tenant-safe reference: the form must belong to the same tenant_id.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.is_submitted IS
schema_composition_service_app     | 'When false, this submission is a draft (submission_version = 0 and submitted_at is NULL). When true, it has been submitted at least once (submission_version >= 1 and submitted_at is required).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.submitted_at IS
schema_composition_service_app     | 'Timestamp of the most recent submit action. NULL for drafts. Updated on re-submit to reflect the latest submission time.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.submission_version IS
schema_composition_service_app     | 'Monotonic counter of how many times the submission has been submitted. Drafts must be 0. First submit sets it to 1. Each re-submit increments it (2, 3, ...).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.is_archived IS
schema_composition_service_app     | 'When true, the submission is archived (retained for history/audit but not actively used). Timestamp consistency is enforced via archived_at.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.archived_at IS
schema_composition_service_app     | 'Timestamp when the submission was archived. Must be non-null only when is_archived is true.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.created_at IS
schema_composition_service_app     | 'Row creation timestamp (typically when the draft submission was first created).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp (updated by application logic or a trigger).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the submission envelope.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the submission envelope.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_submission_value
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Stores captured values for a form submission in a flat, query-friendly shape
schema_composition_service_app     | --   (one row per field instance per submission).
schema_composition_service_app     | --
schema_composition_service_app     | --   Because the storage is intentionally flat, each row also stores a fully
schema_composition_service_app     | --   qualified field path (field_path) that identifies the field instance within
schema_composition_service_app     | --   the form definition tree at the time of submission.
schema_composition_service_app     | --
schema_composition_service_app     | --   This solves two practical problems:
schema_composition_service_app     | --     1) Stable identification across nested structures:
schema_composition_service_app     | --          The same field_def may appear multiple times across different panels
schema_composition_service_app     | --          or embedded components. field_path disambiguates instances.
schema_composition_service_app     | --     2) Human and operational readability:
schema_composition_service_app     | --          field_path allows support, exports, and analytics pipelines to
schema_composition_service_app     | --          understand where the value came from without reconstructing the full
schema_composition_service_app     | --          component tree at query time.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Dual placement model (exactly one path):
schema_composition_service_app     | --       A captured value comes from either:
schema_composition_service_app     | --         A) a direct field placed on a form panel (form_panel_field_id)
schema_composition_service_app     | --         B) a field inside a component placed on a form panel
schema_composition_service_app     | --            (form_panel_component_id + component_panel_field_id)
schema_composition_service_app     | --   - Fully qualified path:
schema_composition_service_app     | --       field_path is a deterministic dot-separated path from the form root
schema_composition_service_app     | --       to the field instance. It is stored redundantly for stability and fast
schema_composition_service_app     | --       lookup.
schema_composition_service_app     | --
schema_composition_service_app     | --       Recommended segment convention (example):
schema_composition_service_app     | --         <form_key>.<form_panel_key>.<field_key>
schema_composition_service_app     | --         <form_key>.<form_panel_key>.<component_panel_key>.<field_key>
schema_composition_service_app     | --
schema_composition_service_app     | --       Notes:
schema_composition_service_app     | --         - Use stable keys, not labels.
schema_composition_service_app     | --         - field_key should come from the effective field_config.field.field_key
schema_composition_service_app     | --           for that specific placement.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --   - tenant_id scopes data to a tenant boundary.
schema_composition_service_app     | --   - Exactly one placement path must be present (direct vs component).
schema_composition_service_app     | --   - field_path is required, nonblank, and unique per submission.
schema_composition_service_app     | --   - The placement-specific uniqueness constraints are retained for safety.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_submission_value (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary and owning submission
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     |     form_submission_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Underlying catalog field definition for this value (provenance / analytics).
schema_composition_service_app     |     -- This may be useful for grouping by field type, even though the actual
schema_composition_service_app     |     -- field instance is identified by field_path + placement references.
schema_composition_service_app     |     field_def_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Fully qualified field instance path (required)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Deterministic dot-separated path to the field instance within the form tree
schema_composition_service_app     |     -- at the time of submission. This is the primary disambiguator for flat storage.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Examples:
schema_composition_service_app     |     --   my_form.my_form_panel.email
schema_composition_service_app     |     --   my_form.my_form_panel.address_component_1.address_panel.state
schema_composition_service_app     |     --
schema_composition_service_app     |     -- The exact segment scheme is a product contract. Keep it stable once released.
schema_composition_service_app     |     field_path VARCHAR(800) NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Placement references (exactly one path)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Direct field placement reference (field placed directly on a form panel).
schema_composition_service_app     |     form_panel_field_id UUID,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Component field placement reference (field inside an embedded component).
schema_composition_service_app     |     form_panel_component_id UUID,
schema_composition_service_app     |     component_panel_field_id UUID,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Captured value
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Captured value (data shape depends on field_def.data_type).
schema_composition_service_app     |     -- Stored as JSONB to support:
schema_composition_service_app     |     --   - scalar values (text, number, boolean)
schema_composition_service_app     |     --   - structured values (dates/datetimes as ISO strings)
schema_composition_service_app     |     --   - arrays for MULTISELECT
schema_composition_service_app     |     --   - future extensions (tokens, references, etc.)
schema_composition_service_app     |     value JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Search surface for global/substring search (maintained by trigger)
schema_composition_service_app     |     value_search_text TEXT,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT ck_form_submission_value_schema
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |         value IS NULL
schema_composition_service_app     |         OR public.jsonb_matches_schema(
schema_composition_service_app     |             $${
schema_composition_service_app     |                 "$schema": "http://json-schema.org/draft-07/schema#",
schema_composition_service_app     |                 "title": "DynoCRM Form Submission Value",
schema_composition_service_app     |                 "type": "object",
schema_composition_service_app     |                 "additionalProperties": false,
schema_composition_service_app     |                 "required": ["data_type", "value"],
schema_composition_service_app     |                 "properties": {
schema_composition_service_app     |                     "data_type": {
schema_composition_service_app     |                     "type": "string",
schema_composition_service_app     |                     "enum": [
schema_composition_service_app     |                         "TEXT",
schema_composition_service_app     |                         "NUMBER",
schema_composition_service_app     |                         "BOOLEAN",
schema_composition_service_app     |                         "DATE",
schema_composition_service_app     |                         "DATETIME",
schema_composition_service_app     |                         "SINGLESELECT",
schema_composition_service_app     |                         "MULTISELECT"
schema_composition_service_app     |                     ]
schema_composition_service_app     |                     },
schema_composition_service_app     |                     "value": {}
schema_composition_service_app     |                 },
schema_composition_service_app     |                 "allOf": [
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "TEXT" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "string" } } }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "DATE" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "string" } } }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "DATETIME" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "string" } } }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "SINGLESELECT" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "string", "minLength": 1, "maxLength": 200 } } }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "MULTISELECT" } } },
schema_composition_service_app     |                     "then": {
schema_composition_service_app     |                         "properties": {
schema_composition_service_app     |                         "value": {
schema_composition_service_app     |                             "type": "array",
schema_composition_service_app     |                             "items": { "type": "string", "minLength": 1, "maxLength": 200 },
schema_composition_service_app     |                             "maxItems": 1000
schema_composition_service_app     |                         }
schema_composition_service_app     |                         }
schema_composition_service_app     |                     }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "NUMBER" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "number" } } }
schema_composition_service_app     |                     },
schema_composition_service_app     |                     {
schema_composition_service_app     |                     "if": { "properties": { "data_type": { "const": "BOOLEAN" } } },
schema_composition_service_app     |                     "then": { "properties": { "value": { "type": "boolean" } } }
schema_composition_service_app     |                     }
schema_composition_service_app     |                 ]
schema_composition_service_app     |             }$$::json,
schema_composition_service_app     |             value
schema_composition_service_app     |         )
schema_composition_service_app     |     ),
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     |     -- Defensive: prevent empty/whitespace-only paths.
schema_composition_service_app     |     CONSTRAINT ck_form_submission_value_field_path_nonblank
schema_composition_service_app     |         CHECK (length(btrim(field_path)) > 0),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Basic format guardrail: dot-separated key segments (allows hyphen and underscore).
schema_composition_service_app     |     -- This does not enforce segment semantics, only shape.
schema_composition_service_app     |     CONSTRAINT ck_form_submission_value_field_path_format
schema_composition_service_app     |         CHECK (field_path ~ '^[A-Za-z0-9_\\-]+(\\.[A-Za-z0-9_\\-]+)+$'),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Exactly one placement path must be set.
schema_composition_service_app     |     CONSTRAINT ck_form_submission_value_path_exclusive
schema_composition_service_app     |         CHECK (
schema_composition_service_app     |             -- direct placement
schema_composition_service_app     |             (
schema_composition_service_app     |               form_panel_field_id IS NOT NULL
schema_composition_service_app     |               AND form_panel_component_id IS NULL
schema_composition_service_app     |               AND component_panel_field_id IS NULL
schema_composition_service_app     |             )
schema_composition_service_app     |             OR
schema_composition_service_app     |             -- component placement
schema_composition_service_app     |             (
schema_composition_service_app     |               form_panel_field_id IS NULL
schema_composition_service_app     |               AND form_panel_component_id IS NOT NULL
schema_composition_service_app     |               AND component_panel_field_id IS NOT NULL
schema_composition_service_app     |             )
schema_composition_service_app     |         ),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Uniqueness: one row per field instance per submission, identified by field_path.
schema_composition_service_app     |     -- This is the primary uniqueness guarantee for the flat storage model.
schema_composition_service_app     |     -- form_submission_id will always be used in seaches so this CONSTRAINT is sufficient
schema_composition_service_app     |     CONSTRAINT uq_form_submission_value_submission_field_path
schema_composition_service_app     |         UNIQUE (tenant_id, form_submission_id, field_path)
schema_composition_service_app     |         DEFERRABLE INITIALLY DEFERRED,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Uniqueness: direct field value per submission (retained as a safety net).
schema_composition_service_app     |     -- form_submission_id will always be used in seaches so this CONSTRAINT is sufficient
schema_composition_service_app     |     CONSTRAINT uq_form_submission_value_direct
schema_composition_service_app     |         UNIQUE (tenant_id, form_submission_id, form_panel_field_id)
schema_composition_service_app     |         DEFERRABLE INITIALLY DEFERRED,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Uniqueness: component field value per submission (retained as a safety net). 
schema_composition_service_app     |     -- form_submission_id will always be used in seaches so this CONSTRAINT is sufficient
schema_composition_service_app     |     CONSTRAINT uq_form_submission_value_component
schema_composition_service_app     |         UNIQUE (tenant_id, form_submission_id,
schema_composition_service_app     |                 form_panel_component_id, component_panel_field_id)
schema_composition_service_app     |         DEFERRABLE INITIALLY DEFERRED,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_submission_value_submission_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, form_submission_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_submission (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_submission_value_field_def_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, field_def_id)
schema_composition_service_app     |         REFERENCES schema_composition.field_def (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_submission_value_form_panel_field_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, form_panel_field_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel_field (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_submission_value_form_panel_component_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, form_panel_component_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel_component (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT,
schema_composition_service_app     | 
schema_composition_service_app     |     CONSTRAINT fk_form_submission_value_component_panel_field_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, component_panel_field_id)
schema_composition_service_app     |         REFERENCES schema_composition.component_panel_field (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes for schema_composition.form_submission_value
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast tenant scoping.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_tenant_id
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Retrieve all values for a submission.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_submission
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id, form_submission_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast lookup of a specific field instance by fully qualified path.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_submission_field_path
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id, form_submission_id, field_path);
schema_composition_service_app     | 
schema_composition_service_app     | -- Filter values by field_def across submissions.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_field_def
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id, field_def_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- Lookup direct field values for a specific panel placement.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_panel_field
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id, form_panel_field_id)
schema_composition_service_app     |     WHERE form_panel_field_id IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | -- Lookup component field values for a specific component placement.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_component_field
schema_composition_service_app     |     ON schema_composition.form_submission_value (
schema_composition_service_app     |         tenant_id,
schema_composition_service_app     |         form_panel_component_id,
schema_composition_service_app     |         component_panel_field_id
schema_composition_service_app     |     )
schema_composition_service_app     |     WHERE form_panel_component_id IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | -- JSONB GIN index for value (useful for searching within captured data).
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_value_gin
schema_composition_service_app     |     ON schema_composition.form_submission_value
schema_composition_service_app     |     USING GIN (value);
schema_composition_service_app     | 
schema_composition_service_app     | -- Recency queries.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_submission_value_tenant_submission_updated_at
schema_composition_service_app     |     ON schema_composition.form_submission_value (tenant_id, form_submission_id, updated_at);
schema_composition_service_app     | 
schema_composition_service_app     | -- CREATE INDEX IF NOT EXISTS ix_fsv_value_search_trgm_lower
schema_composition_service_app     | -- ON schema_composition.form_submission_value
schema_composition_service_app     | -- USING GIN (lower(value_search_text) gin_trgm_ops)
schema_composition_service_app     | -- WHERE value_search_text IS NOT NULL;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Column comments for schema_composition.form_submission_value
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_submission_value IS
schema_composition_service_app     | 'Stores captured values for a specific field instance within a form submission. Each row represents one field instance, identified by field_path. The instance is either a direct field on a form panel (form_panel_field_id) or a field inside a component placed on a form panel (form_panel_component_id + component_panel_field_id). Exactly one of these placement paths must be non-null.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All rows are scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.form_submission_id IS
schema_composition_service_app     | 'Identifier of the form submission this value belongs to.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.field_def_id IS
schema_composition_service_app     | 'Identifier of the underlying catalog field_def used as the provenance/source type for this field instance. Useful for analytics and grouping by field type.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.field_path IS
schema_composition_service_app     | 'Fully qualified dot-separated path identifying the field instance within the form definition tree at the time of submission. Primary disambiguator for flat storage and required to be unique per submission.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.form_panel_field_id IS
schema_composition_service_app     | 'Reference to a direct field placement on a form panel. NULL when the value comes from a field inside a component.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.form_panel_component_id IS
schema_composition_service_app     | 'Reference to a specific component placement on a form panel. Used together with component_panel_field_id to identify a field inside a component.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.component_panel_field_id IS
schema_composition_service_app     | 'Identifier of the field inside a catalog component (component_panel_field). Used together with form_panel_component_id.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.value IS
schema_composition_service_app     | 'Captured field value stored as JSONB. Shape depends on field_def.data_type (e.g., string for TEXT, number for NUMBER, boolean for BOOLEAN, array for MULTISELECT).';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the row.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_submission_value.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the row.';
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Function: schema_composition.compute_form_submission_value_search_text
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Derives a stable, searchable TEXT representation from the JSONB value wrapper:
schema_composition_service_app     | --     { "data_type": "<FIELD_DATA_TYPE>", "value": <typed> }
schema_composition_service_app     | --
schema_composition_service_app     | --   Rules:
schema_composition_service_app     | --     - TEXT/DATE/DATETIME/SINGLESELECT -> trimmed scalar string
schema_composition_service_app     | --     - NUMBER/BOOLEAN                 -> scalar cast to text
schema_composition_service_app     | --     - MULTISELECT                    -> newline-joined array of strings (stable, readable)
schema_composition_service_app     | --
schema_composition_service_app     | -- NOTES
schema_composition_service_app     | --   - Returns NULL for NULL/empty values.
schema_composition_service_app     | --   - Kept in schema_composition to avoid polluting public.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.compute_form_submission_value_search_text(p_value jsonb)
schema_composition_service_app     | RETURNS text
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | IMMUTABLE
schema_composition_service_app     | AS $$
schema_composition_service_app     | DECLARE
schema_composition_service_app     |   dt text;
schema_composition_service_app     |   result text;
schema_composition_service_app     | BEGIN
schema_composition_service_app     |   IF p_value IS NULL THEN
schema_composition_service_app     |     RETURN NULL;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   dt := p_value->>'data_type';
schema_composition_service_app     | 
schema_composition_service_app     |   IF dt IN ('TEXT', 'DATE', 'DATETIME', 'SINGLESELECT') THEN
schema_composition_service_app     |     result := btrim(p_value->>'value');
schema_composition_service_app     |     IF result = '' THEN
schema_composition_service_app     |       RETURN NULL;
schema_composition_service_app     |     END IF;
schema_composition_service_app     |     RETURN result;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   IF dt IN ('NUMBER', 'BOOLEAN') THEN
schema_composition_service_app     |     -- p_value->'value' preserves native JSON scalar type; ::text yields a stable string
schema_composition_service_app     |     result := (p_value->'value')::text;
schema_composition_service_app     |     result := btrim(result);
schema_composition_service_app     |     IF result = '' THEN
schema_composition_service_app     |       RETURN NULL;
schema_composition_service_app     |     END IF;
schema_composition_service_app     |     RETURN result;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   IF dt = 'MULTISELECT' THEN
schema_composition_service_app     |     -- Join array elements with newline. If empty array, result becomes NULL.
schema_composition_service_app     |     SELECT NULLIF(btrim(string_agg(elem, E'\n')), '')
schema_composition_service_app     |       INTO result
schema_composition_service_app     |       FROM jsonb_array_elements_text(p_value->'value') AS t(elem);
schema_composition_service_app     | 
schema_composition_service_app     |     RETURN result;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Unknown/unsupported type: do not index/search
schema_composition_service_app     |   RETURN NULL;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger function: schema_composition.tg_set_form_submission_value_search_text
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Ensures value_search_text stays in sync whenever value changes.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.tg_set_form_submission_value_search_text()
schema_composition_service_app     | RETURNS trigger
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | AS $$
schema_composition_service_app     | BEGIN
schema_composition_service_app     |   -- Always recompute from NEW.value (handles INSERT and UPDATE)
schema_composition_service_app     |   NEW.value_search_text := schema_composition.compute_form_submission_value_search_text(NEW.value);
schema_composition_service_app     |   RETURN NEW;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | DROP TRIGGER IF EXISTS trg_form_submission_value_set_search_text
schema_composition_service_app     | ON schema_composition.form_submission_value;
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER trg_form_submission_value_set_search_text
schema_composition_service_app     | BEFORE INSERT OR UPDATE OF value
schema_composition_service_app     | ON schema_composition.form_submission_value
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.tg_set_form_submission_value_search_text();
schema_composition_service_app     | 
schema_composition_service_app     | -- END original form_schema.sql
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- PHASE 2: Marketplace-grade additions
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table: schema_composition.form_panel_component
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | --   Represents the placement of a reusable catalog component onto a specific
schema_composition_service_app     | --   form panel within a tenant-owned form definition.
schema_composition_service_app     | --
schema_composition_service_app     | -- CORE CONCEPTS
schema_composition_service_app     | --   - Instance identity:
schema_composition_service_app     | --       * Each placement represents a distinct instance of a reusable component.
schema_composition_service_app     | --
schema_composition_service_app     | --   - Composition boundary:
schema_composition_service_app     | --       * A form_panel may embed zero or more reusable components.
schema_composition_service_app     | --       * This table acts as the join/composition layer between:
schema_composition_service_app     | --           - schema_composition.form_panel (form structure)
schema_composition_service_app     | --           - schema_composition.component (reusable catalog component)
schema_composition_service_app     | --
schema_composition_service_app     | --   - Configuration layering:
schema_composition_service_app     | --       * ui_config stores placement-level UI overrides.
schema_composition_service_app     | --       * nested_overrides stores selector-addressed PATCH overrides that apply
schema_composition_service_app     | --         inside the embedded component tree (fields, panels, actions).
schema_composition_service_app     | --
schema_composition_service_app     | -- TENANT SAFETY
schema_composition_service_app     | --   - tenant_id scopes all rows to a tenant boundary.
schema_composition_service_app     | --   - All foreign keys are tenant-safe composites to prevent cross-tenant leakage.
schema_composition_service_app     | --
schema_composition_service_app     | -- IMPORTANT INVARIANTS
schema_composition_service_app     | --     from labels or user-facing text.
schema_composition_service_app     | --   - component_id and panel_id must belong to the same tenant_id.
schema_composition_service_app     | --   - updated_at is maintained by application code or a trigger (not defined here).
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TABLE IF NOT EXISTS schema_composition.form_panel_component (
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Primary identity
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Immutable technical row identifier.
schema_composition_service_app     |     id UUID PRIMARY KEY,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Tenant boundary
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant that owns this component placement.
schema_composition_service_app     |     tenant_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Composition references
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- The form panel on which this component is placed.
schema_composition_service_app     |     -- Must belong to the same tenant_id.
schema_composition_service_app     |     panel_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- The reusable catalog component being placed.
schema_composition_service_app     |     -- Must belong to the same tenant_id.
schema_composition_service_app     |     component_id UUID NOT NULL,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Configuration overrides
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSONB UI configuration overrides applied at the placement level.
schema_composition_service_app     |     -- These overrides are layered on top of the component's catalog ui_config.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- PATCH semantics:
schema_composition_service_app     |     --   - Objects are merged
schema_composition_service_app     |     --   - Arrays are replaced
schema_composition_service_app     |     --   - Null values remove keys
schema_composition_service_app     |     ui_config JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional JSONB document containing selector-addressed PATCH overrides
schema_composition_service_app     |     -- that apply inside the embedded component tree.
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Used to customize:
schema_composition_service_app     |     --   - component panels
schema_composition_service_app     |     --   - component fields
schema_composition_service_app     |     --   - panel actions
schema_composition_service_app     |     --
schema_composition_service_app     |     -- Overrides do NOT mutate the catalog component.
schema_composition_service_app     |     nested_overrides JSONB,
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Audit columns
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Row creation timestamp.
schema_composition_service_app     |     created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Row last-updated timestamp.
schema_composition_service_app     |     -- Typically maintained by application code or a trigger.
schema_composition_service_app     |     updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional actor identifier (username/service) that created the row.
schema_composition_service_app     |     created_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- Optional actor identifier (username/service) that last updated the row.
schema_composition_service_app     |     updated_by VARCHAR(100),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Constraints
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Canonical tenant-safe helper unique constraint.
schema_composition_service_app     |     -- Supports composite tenant-safe foreign keys from child tables.
schema_composition_service_app     |     CONSTRAINT ux_form_panel_component_tenant_id
schema_composition_service_app     |         UNIQUE (tenant_id, id),
schema_composition_service_app     | 
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     |     -- Foreign keys (tenant-safe)
schema_composition_service_app     |     -- ------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK enforcing form_panel ownership.
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_form_panel_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, panel_id)
schema_composition_service_app     |         REFERENCES schema_composition.form_panel (tenant_id, id)
schema_composition_service_app     |         ON DELETE CASCADE,
schema_composition_service_app     | 
schema_composition_service_app     |     -- Tenant-safe FK enforcing component ownership.
schema_composition_service_app     |     CONSTRAINT fk_form_panel_component_component_tenant
schema_composition_service_app     |         FOREIGN KEY (tenant_id, component_id)
schema_composition_service_app     |         REFERENCES schema_composition.component (tenant_id, id)
schema_composition_service_app     |         ON DELETE RESTRICT
schema_composition_service_app     | );
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Indexes
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- Fast lookup of all form placements for a given component.
schema_composition_service_app     | CREATE INDEX IF NOT EXISTS ix_form_panel_component_tenant_component
schema_composition_service_app     |     ON schema_composition.form_panel_component (tenant_id, component_id);
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Table and column comments
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON TABLE schema_composition.form_panel_component IS
schema_composition_service_app     | 'Placement of a reusable catalog component onto a specific form panel. Acts as the composition layer between form structure and reusable components.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.id IS
schema_composition_service_app     | 'Primary row identifier (UUID). Immutable technical identity for the component placement.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.tenant_id IS
schema_composition_service_app     | 'Tenant boundary. All component placements are strictly scoped to a tenant for isolation and access control.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.panel_id IS
schema_composition_service_app     | 'Identifier of the owning form panel (schema_composition.form_panel.id) on which this component is placed.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.component_id IS
schema_composition_service_app     | 'Identifier of the reusable catalog component (schema_composition.component.id) being placed on the form panel.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.ui_config IS
schema_composition_service_app     | 'Optional JSONB UI configuration overrides applied at the component placement level. PATCH semantics: objects merge, arrays replace, null values remove keys.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.nested_overrides IS
schema_composition_service_app     | 'Optional JSONB document containing selector-addressed PATCH overrides applied within the embedded component tree (panels, fields, actions) without mutating catalog definitions.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.created_at IS
schema_composition_service_app     | 'Row creation timestamp.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.updated_at IS
schema_composition_service_app     | 'Row last-updated timestamp. Typically maintained by application code or a trigger.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.created_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that created the component placement.';
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON COLUMN schema_composition.form_panel_component.updated_by IS
schema_composition_service_app     | 'Optional actor identifier (username/service) that last updated the component placement.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- PHASE 3: Deterministic JSONB merge utilities
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.jsonb_merge_deterministic(
schema_composition_service_app     |     target jsonb,
schema_composition_service_app     |     patch jsonb,
schema_composition_service_app     |     null_means_remove boolean DEFAULT true,
schema_composition_service_app     |     array_mode text DEFAULT 'REPLACE'
schema_composition_service_app     | ) RETURNS jsonb
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | IMMUTABLE
schema_composition_service_app     | STRICT
schema_composition_service_app     | AS $$
schema_composition_service_app     | DECLARE
schema_composition_service_app     |     result jsonb := COALESCE(target, '{}'::jsonb);
schema_composition_service_app     |     key text;
schema_composition_service_app     |     value jsonb;
schema_composition_service_app     |     target_val jsonb;
schema_composition_service_app     | BEGIN
schema_composition_service_app     |     IF patch IS NULL THEN
schema_composition_service_app     |         RETURN result;
schema_composition_service_app     |     END IF;
schema_composition_service_app     |     IF jsonb_typeof(patch) <> 'object' THEN
schema_composition_service_app     |         IF jsonb_typeof(patch) = 'array' AND jsonb_typeof(target) = 'array' THEN
schema_composition_service_app     |             IF upper(array_mode) = 'APPEND' THEN
schema_composition_service_app     |                 RETURN COALESCE(target, '[]'::jsonb) || patch;
schema_composition_service_app     |             ELSE
schema_composition_service_app     |                 RETURN patch;
schema_composition_service_app     |             END IF;
schema_composition_service_app     |         ELSE
schema_composition_service_app     |             RETURN patch;
schema_composition_service_app     |         END IF;
schema_composition_service_app     |     END IF;
schema_composition_service_app     |     FOR key, value IN SELECT key, value FROM jsonb_each(patch) ORDER BY key LOOP
schema_composition_service_app     |         target_val := result -> key;
schema_composition_service_app     |         IF value IS NULL THEN
schema_composition_service_app     |             IF null_means_remove THEN
schema_composition_service_app     |                 result := result - key;
schema_composition_service_app     |             ELSE
schema_composition_service_app     |                 result := result || jsonb_build_object(key, NULL);
schema_composition_service_app     |             END IF;
schema_composition_service_app     |         ELSE
schema_composition_service_app     |             IF jsonb_typeof(value) = 'object' AND jsonb_typeof(target_val) = 'object' THEN
schema_composition_service_app     |                 result := result || jsonb_build_object(
schema_composition_service_app     |                     key,
schema_composition_service_app     |                     schema_composition.jsonb_merge_deterministic(target_val, value, null_means_remove, array_mode)
schema_composition_service_app     |                 );
schema_composition_service_app     |             ELSIF jsonb_typeof(value) = 'array' AND jsonb_typeof(target_val) = 'array' THEN
schema_composition_service_app     |                 IF upper(array_mode) = 'APPEND' THEN
schema_composition_service_app     |                     result := result || jsonb_build_object(key, target_val || value);
schema_composition_service_app     |                 ELSE
schema_composition_service_app     |                     result := result || jsonb_build_object(key, value);
schema_composition_service_app     |                 END IF;
schema_composition_service_app     |             ELSE
schema_composition_service_app     |                 result := result || jsonb_build_object(key, value);
schema_composition_service_app     |             END IF;
schema_composition_service_app     |         END IF;
schema_composition_service_app     |     END LOOP;
schema_composition_service_app     |     RETURN result;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.jsonb_merge_default(
schema_composition_service_app     |     target jsonb,
schema_composition_service_app     |     patch jsonb
schema_composition_service_app     | ) RETURNS jsonb
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | IMMUTABLE
schema_composition_service_app     | STRICT
schema_composition_service_app     | AS $$
schema_composition_service_app     | BEGIN
schema_composition_service_app     |     RETURN schema_composition.jsonb_merge_deterministic(target, patch, true, 'REPLACE');
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON FUNCTION schema_composition.jsonb_merge_deterministic(jsonb, jsonb, boolean, text) IS
schema_composition_service_app     |     'Deterministically merges two JSONB documents with configurable null and array semantics. Objects are merged recursively; arrays are either replaced or appended depending on array_mode; nulls remove keys when null_means_remove is true or set keys to JSON null otherwise. Keys are processed in sorted order for deterministic results.';
schema_composition_service_app     | COMMENT ON FUNCTION schema_composition.jsonb_merge_default(jsonb, jsonb) IS
schema_composition_service_app     |     'Convenience wrapper around jsonb_merge_deterministic that uses platform defaults: arrays are replaced and null values remove keys.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Block updates and deletes to published objects
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | --
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | -- -------
schema_composition_service_app     | -- Enforces immutability for artifacts that have been marked as published.
schema_composition_service_app     | --
schema_composition_service_app     | -- Once an artifact is published, it becomes a stable, externally visible
schema_composition_service_app     | -- contract (e.g. marketplace artifact, provider catalog entry, or
schema_composition_service_app     | -- production form definition). Allowing in-place updates or deletes would:
schema_composition_service_app     | --
schema_composition_service_app     | --   - break referential and behavioral expectations
schema_composition_service_app     | --   - invalidate cached client behavior and builder assumptions
schema_composition_service_app     | --   - make marketplace upgrades and drift detection unreliable
schema_composition_service_app     | --   - complicate audit, support, and rollback workflows
schema_composition_service_app     | --   - risk loss or mutation of data that depends on the published shape
schema_composition_service_app     | --
schema_composition_service_app     | -- This trigger-based enforcement guarantees that *no UPDATE or DELETE*
schema_composition_service_app     | -- can modify a published row, regardless of which application, service,
schema_composition_service_app     | -- or script attempts the change.
schema_composition_service_app     | --
schema_composition_service_app     | -- DESIGN NOTES
schema_composition_service_app     | -- ------------
schema_composition_service_app     | -- * Implemented as BEFORE UPDATE / BEFORE DELETE triggers so violations are
schema_composition_service_app     | --   caught early and abort the statement.
schema_composition_service_app     | -- * Uses OLD.is_published to ensure that once a row is published, it cannot
schema_composition_service_app     | --   be modified or removed in place.
schema_composition_service_app     | -- * Applies uniformly across all artifact tables that share the
schema_composition_service_app     | --   `is_published` semantic.
schema_composition_service_app     | -- * Encourages a clone-and-edit or versioning workflow instead of mutation.
schema_composition_service_app     | --
schema_composition_service_app     | -- FUTURE CONSIDERATIONS
schema_composition_service_app     | -- ---------------------
schema_composition_service_app     | -- * You mentioned a potential exception for archived objects. That is TBD.
schema_composition_service_app     | --   This policy currently prioritizes protecting existing data and stability.
schema_composition_service_app     | --
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger function: schema_composition.block_writes_when_published
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- FUNCTIONALITY
schema_composition_service_app     | -- -------------
schema_composition_service_app     | -- Blocks UPDATE and DELETE operations on rows that are already published
schema_composition_service_app     | -- (is_published = true).
schema_composition_service_app     | --
schema_composition_service_app     | -- The function is table-agnostic and relies only on:
schema_composition_service_app     | --   - the presence of an `is_published` boolean column
schema_composition_service_app     | --   - row-level trigger context (OLD / NEW)
schema_composition_service_app     | --   - trigger operation (TG_OP)
schema_composition_service_app     | --
schema_composition_service_app     | -- BEHAVIOR
schema_composition_service_app     | -- --------
schema_composition_service_app     | -- * If OLD.is_published is true:
schema_composition_service_app     | --     - Raise an exception
schema_composition_service_app     | --     - Abort the UPDATE or DELETE
schema_composition_service_app     | -- * If OLD.is_published is false:
schema_composition_service_app     | --     - Allow the operation to proceed normally
schema_composition_service_app     | --
schema_composition_service_app     | -- ERROR SEMANTICS
schema_composition_service_app     | -- ---------------
schema_composition_service_app     | -- * Uses SQLSTATE `check_violation` to clearly signal a data integrity rule
schema_composition_service_app     | --   violation rather than a generic runtime error.
schema_composition_service_app     | -- * Includes schema, table name, and operation in the error detail for
schema_composition_service_app     | --   easier debugging and log correlation.
schema_composition_service_app     | -- * Provides a human-readable hint guiding the correct workflow
schema_composition_service_app     | --   (clone or unpublish before editing).
schema_composition_service_app     | --
schema_composition_service_app     | -- EXTENSIBILITY
schema_composition_service_app     | -- -------------
schema_composition_service_app     | -- If future requirements introduce:
schema_composition_service_app     | --   - admin bypass for migrations/support
schema_composition_service_app     | --   - archived exceptions
schema_composition_service_app     | --   - partial mutability of specific columns
schema_composition_service_app     | --   - versioned publishing (new row per publish)
schema_composition_service_app     | --
schema_composition_service_app     | -- this function can be extended or wrapped without changing existing triggers.
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.block_writes_when_published()
schema_composition_service_app     | RETURNS trigger
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | AS $$
schema_composition_service_app     | BEGIN
schema_composition_service_app     |   -- Guardrail: block writes to rows that are already published.
schema_composition_service_app     |   IF OLD.is_published IS TRUE THEN
schema_composition_service_app     |     RAISE EXCEPTION '% is not allowed for published artifacts.', TG_OP
schema_composition_service_app     |       USING
schema_composition_service_app     |         -- Signals a constraint-style violation rather than a runtime error.
schema_composition_service_app     |         ERRCODE = 'check_violation',
schema_composition_service_app     | 
schema_composition_service_app     |         -- Includes table identity and operation for precise diagnostics.
schema_composition_service_app     |         DETAIL  = format(
schema_composition_service_app     |                     'Operation=%s Table=%I.%I row is published',
schema_composition_service_app     |                     TG_OP,
schema_composition_service_app     |                     TG_TABLE_SCHEMA,
schema_composition_service_app     |                     TG_TABLE_NAME
schema_composition_service_app     |                   ),
schema_composition_service_app     | 
schema_composition_service_app     |         -- Directs developers and users toward the intended workflow.
schema_composition_service_app     |         HINT    = 'Clone or unpublish the artifact before modifying or deleting it.';
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow UPDATE to proceed by returning NEW.
schema_composition_service_app     |   IF TG_OP = 'UPDATE' THEN
schema_composition_service_app     |     RETURN NEW;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow DELETE to proceed by returning OLD.
schema_composition_service_app     |   RETURN OLD;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON FUNCTION schema_composition.block_writes_when_published() IS
schema_composition_service_app     | 'Trigger function that enforces immutability for published artifacts. When OLD.is_published = true, it blocks UPDATE and DELETE operations by raising a check_violation exception. Intended for attachment via BEFORE UPDATE/DELETE triggers on top-level artifact tables that include an is_published boolean (e.g., field definitions, components, forms). Provides clear diagnostics (schema/table/operation) and a workflow hint directing callers to clone or unpublish before modifying.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger attachments (top-level published artifacts)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- These triggers apply the immutability rule to all core artifact tables
schema_composition_service_app     | -- that support publishing semantics.
schema_composition_service_app     | --
schema_composition_service_app     | -- Covered tables (top-level published objects):
schema_composition_service_app     | --   - schema_composition.field_def
schema_composition_service_app     | --   - schema_composition.component
schema_composition_service_app     | --   - schema_composition.form
schema_composition_service_app     | --
schema_composition_service_app     | -- Each table receives:
schema_composition_service_app     | --   - BEFORE UPDATE trigger
schema_composition_service_app     | --   - BEFORE DELETE trigger
schema_composition_service_app     | --
schema_composition_service_app     | -- NOTE
schema_composition_service_app     | -- ----
schema_composition_service_app     | -- All of these tables must share the same `is_published` meaning:
schema_composition_service_app     | -- once true, the row represents a stable, externally consumable artifact.
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.field_def
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.field_def
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.field_def
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.component
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.component
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.component
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.form
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.form
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.form
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_published();
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Block updates and deletes to form structure when the parent form is published
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | --
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | -- -------
schema_composition_service_app     | -- Enforces immutability of a form's structural hierarchy once the parent
schema_composition_service_app     | -- form has been marked as published.
schema_composition_service_app     | --
schema_composition_service_app     | -- This prevents in-place modification or deletion of:
schema_composition_service_app     | --   - form panels
schema_composition_service_app     | --   - fields placed directly on form panels
schema_composition_service_app     | --   - embedded component placements within form panels
schema_composition_service_app     | --
schema_composition_service_app     | -- once the owning form is published.
schema_composition_service_app     | --
schema_composition_service_app     | -- Why delete is also blocked:
schema_composition_service_app     | --   - Deleting structural nodes from a published form changes its effective
schema_composition_service_app     | --     schema and breaks stability guarantees.
schema_composition_service_app     | --   - Published forms must remain reproducible over time for support/audit
schema_composition_service_app     | --     and to protect submission interpretation.
schema_composition_service_app     | --
schema_composition_service_app     | -- SCOPE
schema_composition_service_app     | -- -----
schema_composition_service_app     | -- Covered child tables (form structure):
schema_composition_service_app     | --   - schema_composition.form_panel
schema_composition_service_app     | --   - schema_composition.form_panel_field
schema_composition_service_app     | --   - schema_composition.form_panel_component
schema_composition_service_app     | --
schema_composition_service_app     | -- DESIGN NOTES
schema_composition_service_app     | -- ------------
schema_composition_service_app     | -- * Implemented as a BEFORE UPDATE / BEFORE DELETE trigger on each child table.
schema_composition_service_app     | -- * Child tables do not need is_published themselves; publish state is derived
schema_composition_service_app     | --   from the owning schema_composition.form.
schema_composition_service_app     | -- * Tenant isolation is enforced via (tenant_id, id) join constraints.
schema_composition_service_app     | --
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger function: schema_composition.block_writes_when_parent_form_published
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- FUNCTIONALITY
schema_composition_service_app     | -- -------------
schema_composition_service_app     | -- Blocks UPDATE and DELETE operations on form-related child rows when their
schema_composition_service_app     | -- owning form is already published.
schema_composition_service_app     | --
schema_composition_service_app     | -- PARENT RESOLUTION STRATEGY
schema_composition_service_app     | -- --------------------------
schema_composition_service_app     | -- 1) schema_composition.form_panel
schema_composition_service_app     | --    - child row contains form_id directly
schema_composition_service_app     | --    - lookup: form(tenant_id, id) = (OLD.tenant_id, OLD.form_id)
schema_composition_service_app     | --
schema_composition_service_app     | -- 2) schema_composition.form_panel_field, schema_composition.form_panel_component
schema_composition_service_app     | --    - child row contains panel_id
schema_composition_service_app     | --    - resolve form via form_panel then join to form
schema_composition_service_app     | --
schema_composition_service_app     | -- SAFETY GUARDRAIL
schema_composition_service_app     | -- ---------------
schema_composition_service_app     | -- If this function is attached to an unsupported table name, it raises an
schema_composition_service_app     | -- exception. This avoids silent misconfiguration that could weaken the
schema_composition_service_app     | -- immutability policy.
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.block_writes_when_parent_form_published()
schema_composition_service_app     | RETURNS trigger
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | AS $$
schema_composition_service_app     | DECLARE
schema_composition_service_app     |   parent_published boolean;
schema_composition_service_app     | BEGIN
schema_composition_service_app     |   -- Resolve parent form publish state based on triggering table.
schema_composition_service_app     |   IF TG_TABLE_NAME = 'form_panel' THEN
schema_composition_service_app     |     SELECT f.is_published
schema_composition_service_app     |       INTO parent_published
schema_composition_service_app     |       FROM schema_composition.form f
schema_composition_service_app     |      WHERE f.tenant_id = OLD.tenant_id
schema_composition_service_app     |        AND f.id = OLD.form_id;
schema_composition_service_app     | 
schema_composition_service_app     |   ELSIF TG_TABLE_NAME IN ('form_panel_field', 'form_panel_component') THEN
schema_composition_service_app     |     SELECT f.is_published
schema_composition_service_app     |       INTO parent_published
schema_composition_service_app     |       FROM schema_composition.form_panel p
schema_composition_service_app     |       JOIN schema_composition.form f
schema_composition_service_app     |         ON f.tenant_id = p.tenant_id
schema_composition_service_app     |        AND f.id = p.form_id
schema_composition_service_app     |      WHERE p.tenant_id = OLD.tenant_id
schema_composition_service_app     |        AND p.id = OLD.panel_id;
schema_composition_service_app     | 
schema_composition_service_app     |   ELSE
schema_composition_service_app     |     -- Misconfiguration guardrail: do not silently allow writes.
schema_composition_service_app     |     RAISE EXCEPTION 'Trigger function % attached to unsupported table %.%',
schema_composition_service_app     |       'schema_composition.block_writes_when_parent_form_published()',
schema_composition_service_app     |       TG_TABLE_SCHEMA,
schema_composition_service_app     |       TG_TABLE_NAME
schema_composition_service_app     |       USING ERRCODE = 'invalid_parameter_value';
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Enforce immutability if the parent form is published.
schema_composition_service_app     |   IF parent_published IS TRUE THEN
schema_composition_service_app     |     RAISE EXCEPTION '% is not allowed: parent form is published.', TG_OP
schema_composition_service_app     |       USING
schema_composition_service_app     |         ERRCODE = 'check_violation',
schema_composition_service_app     |         DETAIL  = format(
schema_composition_service_app     |                     'Operation=%s Table=%I.%I parent form is published',
schema_composition_service_app     |                     TG_OP,
schema_composition_service_app     |                     TG_TABLE_SCHEMA,
schema_composition_service_app     |                     TG_TABLE_NAME
schema_composition_service_app     |                   ),
schema_composition_service_app     |         HINT    = 'Clone the form (or edit an unpublished draft) before modifying or deleting its panels or fields.';
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow UPDATE to proceed by returning NEW.
schema_composition_service_app     |   IF TG_OP = 'UPDATE' THEN
schema_composition_service_app     |     RETURN NEW;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow DELETE to proceed by returning OLD.
schema_composition_service_app     |   RETURN OLD;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON FUNCTION schema_composition.block_writes_when_parent_form_published() IS
schema_composition_service_app     | 'Trigger function that enforces immutability of form structure rows when the owning parent form is published. Used as a BEFORE UPDATE/DELETE trigger on form child tables (e.g., form_panel, form_panel_field, form_panel_component). Resolves parent publish state using tenant-safe joins (either directly via form_id or indirectly via panel_id -> form_panel -> form). If the parent form is published, blocks the write with check_violation. Includes a guardrail that raises invalid_parameter_value if attached to an unsupported table to prevent silent misconfiguration.';
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger attachments (form structure children)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- Each table receives:
schema_composition_service_app     | --   - BEFORE UPDATE trigger
schema_composition_service_app     | --   - BEFORE DELETE trigger
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.form_panel
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_parent_form_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.form_panel
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_parent_form_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.form_panel
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.form_panel_field
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_parent_form_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.form_panel_field
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_parent_form_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.form_panel_field
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.form_panel_component
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_parent_form_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.form_panel_component
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_parent_form_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.form_panel_component
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_form_published();
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- Block updates and deletes to component structure when the parent component is published
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | --
schema_composition_service_app     | -- PURPOSE
schema_composition_service_app     | -- -------
schema_composition_service_app     | -- Enforces immutability for the structural tree beneath a reusable component
schema_composition_service_app     | -- once that component has been published.
schema_composition_service_app     | --
schema_composition_service_app     | -- This prevents in-place modification or deletion of:
schema_composition_service_app     | --   - component panels
schema_composition_service_app     | --   - fields placed on component panels
schema_composition_service_app     | --
schema_composition_service_app     | -- once the owning component is published.
schema_composition_service_app     | --
schema_composition_service_app     | -- Why delete is also blocked:
schema_composition_service_app     | --   - Deleting panel/field nodes changes the published component definition.
schema_composition_service_app     | --   - Published components may be referenced by forms; structural deletion would
schema_composition_service_app     | --     break reproducibility and stability guarantees.
schema_composition_service_app     | --
schema_composition_service_app     | -- SCOPE
schema_composition_service_app     | -- -----
schema_composition_service_app     | -- Covered child tables (component structure):
schema_composition_service_app     | --   - schema_composition.component_panel
schema_composition_service_app     | --   - schema_composition.component_panel_field
schema_composition_service_app     | --
schema_composition_service_app     | -- DESIGN NOTES
schema_composition_service_app     | -- ------------
schema_composition_service_app     | -- * Implemented as a BEFORE UPDATE / BEFORE DELETE trigger on each child table.
schema_composition_service_app     | -- * Child tables do not need is_published themselves; publish state is derived
schema_composition_service_app     | --   from the owning schema_composition.component.
schema_composition_service_app     | -- * Tenant isolation is enforced via tenant-safe joins.
schema_composition_service_app     | --
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger function: schema_composition.block_writes_when_parent_component_published
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- FUNCTIONALITY
schema_composition_service_app     | -- -------------
schema_composition_service_app     | -- Blocks UPDATE and DELETE operations on component child rows when their
schema_composition_service_app     | -- owning component is already published.
schema_composition_service_app     | --
schema_composition_service_app     | -- PARENT RESOLUTION STRATEGY
schema_composition_service_app     | -- --------------------------
schema_composition_service_app     | -- 1) schema_composition.component_panel
schema_composition_service_app     | --    - child row contains component_id directly
schema_composition_service_app     | --    - lookup: component(tenant_id, id) = (OLD.tenant_id, OLD.component_id)
schema_composition_service_app     | --
schema_composition_service_app     | -- 2) schema_composition.component_panel_field
schema_composition_service_app     | --    - child row contains panel_id
schema_composition_service_app     | --    - resolve component via component_panel then join to component
schema_composition_service_app     | --
schema_composition_service_app     | -- SAFETY GUARDRAIL
schema_composition_service_app     | -- ---------------
schema_composition_service_app     | -- If this function is attached to an unsupported table name, it raises an
schema_composition_service_app     | -- exception. This avoids silent misconfiguration that could weaken the
schema_composition_service_app     | -- immutability policy.
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | CREATE OR REPLACE FUNCTION schema_composition.block_writes_when_parent_component_published()
schema_composition_service_app     | RETURNS trigger
schema_composition_service_app     | LANGUAGE plpgsql
schema_composition_service_app     | AS $$
schema_composition_service_app     | DECLARE
schema_composition_service_app     |   parent_published boolean;
schema_composition_service_app     | BEGIN
schema_composition_service_app     |   -- Resolve parent component publish state based on triggering table.
schema_composition_service_app     |   IF TG_TABLE_NAME = 'component_panel' THEN
schema_composition_service_app     |     SELECT c.is_published
schema_composition_service_app     |       INTO parent_published
schema_composition_service_app     |       FROM schema_composition.component c
schema_composition_service_app     |      WHERE c.tenant_id = OLD.tenant_id
schema_composition_service_app     |        AND c.id = OLD.component_id;
schema_composition_service_app     | 
schema_composition_service_app     |   ELSIF TG_TABLE_NAME = 'component_panel_field' THEN
schema_composition_service_app     |     SELECT c.is_published
schema_composition_service_app     |       INTO parent_published
schema_composition_service_app     |       FROM schema_composition.component_panel p
schema_composition_service_app     |       JOIN schema_composition.component c
schema_composition_service_app     |         ON c.tenant_id = p.tenant_id
schema_composition_service_app     |        AND c.id = p.component_id
schema_composition_service_app     |      WHERE p.tenant_id = OLD.tenant_id
schema_composition_service_app     |        AND p.id = OLD.panel_id;
schema_composition_service_app     | 
schema_composition_service_app     |   ELSE
schema_composition_service_app     |     -- Misconfiguration guardrail: do not silently allow writes.
schema_composition_service_app     |     RAISE EXCEPTION 'Trigger function % attached to unsupported table %.%',
schema_composition_service_app     |       'schema_composition.block_writes_when_parent_component_published()',
schema_composition_service_app     |       TG_TABLE_SCHEMA,
schema_composition_service_app     |       TG_TABLE_NAME
schema_composition_service_app     |       USING ERRCODE = 'invalid_parameter_value';
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Enforce immutability if the parent component is published.
schema_composition_service_app     |   IF parent_published IS TRUE THEN
schema_composition_service_app     |     RAISE EXCEPTION '% is not allowed: parent component is published.', TG_OP
schema_composition_service_app     |       USING
schema_composition_service_app     |         ERRCODE = 'check_violation',
schema_composition_service_app     |         DETAIL  = format(
schema_composition_service_app     |                     'Operation=%s Table=%I.%I parent component is published',
schema_composition_service_app     |                     TG_OP,
schema_composition_service_app     |                     TG_TABLE_SCHEMA,
schema_composition_service_app     |                     TG_TABLE_NAME
schema_composition_service_app     |                   ),
schema_composition_service_app     |         HINT    = 'Clone the component (or edit an unpublished draft) before modifying or deleting its panels or fields.';
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow UPDATE to proceed by returning NEW.
schema_composition_service_app     |   IF TG_OP = 'UPDATE' THEN
schema_composition_service_app     |     RETURN NEW;
schema_composition_service_app     |   END IF;
schema_composition_service_app     | 
schema_composition_service_app     |   -- Allow DELETE to proceed by returning OLD.
schema_composition_service_app     |   RETURN OLD;
schema_composition_service_app     | END;
schema_composition_service_app     | $$;
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | COMMENT ON FUNCTION schema_composition.block_writes_when_parent_component_published() IS
schema_composition_service_app     | 'Trigger function that enforces immutability of component structure rows when the owning parent component is published. Used as a BEFORE UPDATE/DELETE trigger on component child tables (e.g., component_panel, component_panel_field). Resolves parent publish state using tenant-safe joins (either directly via component_id or indirectly via panel_id -> component_panel -> component). If the parent component is published, blocks the write with check_violation. Includes a guardrail that raises invalid_parameter_value if attached to an unsupported table to prevent silent misconfiguration.';
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | -- Trigger attachments (component structure children)
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | --
schema_composition_service_app     | -- Each table receives:
schema_composition_service_app     | --   - BEFORE UPDATE trigger
schema_composition_service_app     | --   - BEFORE DELETE trigger
schema_composition_service_app     | --
schema_composition_service_app     | -- ----------------------------------------------------------------------
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.component_panel
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_parent_component_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.component_panel
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_component_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_parent_component_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.component_panel
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_component_published();
schema_composition_service_app     | 
schema_composition_service_app     | -- schema_composition.component_panel_field
schema_composition_service_app     | CREATE TRIGGER tr_block_writes_when_parent_component_published
schema_composition_service_app     | BEFORE UPDATE ON schema_composition.component_panel_field
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_component_published();
schema_composition_service_app     | 
schema_composition_service_app     | CREATE TRIGGER tr_block_deletes_when_parent_component_published
schema_composition_service_app     | BEFORE DELETE ON schema_composition.component_panel_field
schema_composition_service_app     | FOR EACH ROW
schema_composition_service_app     | EXECUTE FUNCTION schema_composition.block_writes_when_parent_component_published();
schema_composition_service_app     | 
schema_composition_service_app     | 
schema_composition_service_app     | -- ======================================================================
schema_composition_service_app     | -- End of updated schema
schema_composition_service_app     | -- ======================================================================;
schema_composition_service_app     | 
schema_composition_service_app     | INSERT INTO schema_composition.databasechangelog (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS, EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID) VALUES ('raw', 'includeAll', 'migrations/liquibase/sql/001_init_schema.sql', NOW(), 1, '8:376b9b76d30b2fd38314437fdd315f36', 'sql', '', 'EXECUTED', NULL, NULL, '4.21.1', '8449206577');
schema_composition_service_app     | 
schema_composition_service_app     | -- Release Database Lock
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | UPDATE schema_composition.databasechangeloglock SET LOCKED = FALSE, LOCKEDBY = NULL, LOCKGRANTED = NULL WHERE ID = 1;
schema_composition_service_app     | 
schema_composition_service_app     | SET SEARCH_PATH TO schema_composition, "\$user","public","auth","extensions";
schema_composition_service_app     | 
schema_composition_service_app     | Liquibase command 'updateSql' was executed successfully.
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:26.772597Z", "level": "WARNING", "name": "pyliquibase", "message": "Current working dir is /app"}
schema_composition_service_app     | ####################################################
schema_composition_service_app     | ##   _     _             _ _                      ##
schema_composition_service_app     | ##  | |   (_)           (_) |                     ##
schema_composition_service_app     | ##  | |    _  __ _ _   _ _| |__   __ _ ___  ___   ##
schema_composition_service_app     | ##  | |   | |/ _` | | | | | '_ \ / _` / __|/ _ \  ##
schema_composition_service_app     | ##  | |___| | (_| | |_| | | |_) | (_| \__ \  __/  ##
schema_composition_service_app     | ##  \_____/_|\__, |\__,_|_|_.__/ \__,_|___/\___|  ##
schema_composition_service_app     | ##              | |                               ##
schema_composition_service_app     | ##              |_|                               ##
schema_composition_service_app     | ##                                                ## 
schema_composition_service_app     | ##  Get documentation at docs.liquibase.com       ##
schema_composition_service_app     | ##  Get certified courses at learn.liquibase.com  ## 
schema_composition_service_app     | ##  Free schema change activity reports at        ##
schema_composition_service_app     | ##      https://hub.liquibase.com                 ##
schema_composition_service_app     | ##                                                ##
schema_composition_service_app     | ####################################################
schema_composition_service_app     | Starting Liquibase at 03:53:26 (version 4.21.1 #9070 built at 2023-04-13 20:56+0000)
schema_composition_service_app     | Liquibase Version: 4.21.1
schema_composition_service_app     | Liquibase Open Source 4.21.1 by Liquibase
schema_composition_service_app     | Running Changeset: migrations/liquibase/sql/001_init_schema.sql::raw::includeAll
schema_composition_service_app     | 
schema_composition_service_app     | UPDATE SUMMARY
schema_composition_service_app     | Run:                          1
schema_composition_service_app     | Previously run:               0
schema_composition_service_app     | Filtered out:                 0
schema_composition_service_app     | -------------------------------
schema_composition_service_app     | Total change sets:            1
schema_composition_service_app     | 
schema_composition_service_app     | Liquibase: Update has been successful.
schema_composition_service_app     | Liquibase command 'update' was executed successfully.
schema_composition_service_app     | {"timestamp": "2026-01-15T03:53:26.998155Z", "level": "INFO", "name": "root", "message": "Liquibase update completed"}
schema_composition_service_app     | INFO:     Application startup complete.
schema_composition_service_app     | INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
schema_composition_db              |  2026-01-15 03:54:40.779 UTC [191] LOG:  checkpoint starting: time
